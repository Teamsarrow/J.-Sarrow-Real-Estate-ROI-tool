<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sarrow Real Estate Investments - Pro Forma</title>

    <meta property="og:title" content="Sarrow Real Estate Investments" />
    <meta property="og:description" content="Estimate cash flow, returns, and 5-year projections for your next rental property." />
    <meta property="og:image" content="https://placehold.co/1200x630/0A1A44/CFAF66?text=Multifamily+Pro+Forma" />
    <meta property="og:type" content="website" />

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* Custom Styles for Print and Font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Lighter, modern background */
        }
        .report-container {
            box-shadow: 0 10px 30px rgba(10, 26, 68, 0.15); /* Deeper shadow */
        }
        .data-input,
        .data-input-text {
            transition: all 0.2s;
            /* Uniform padding and text size for inputs */
            padding: 4px;
            font-size: 0.875rem; /* text-sm */
        }
        /* Style for number inputs specifically for right alignment and color */
        .data-input {
            text-align: right;
            font-weight: 600;
            color: #1e40af; /* Blue */
        }
        .data-input:focus,
        .data-input-text:focus {
            outline: 2px solid #CFAF66; /* Gold focus ring */
            border-color: #CFAF66;
            box-shadow: 0 0 0 2px rgba(207, 175, 102, 0.5);
        }

        /* Utility for calculation outputs */
        .calc-cell {
            color: #4b5563;
            font-weight: 500;
        }
        .positive-return {
            color: #059669; /* Emerald Green */
        }
        .negative-value {
            color: #ef4444; /* Red 500 */
            font-weight: 600;
        }
        .kpi-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }

        /* Tab styling */
        .tab-button {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.2s;
            color: #4b5563; /* Gray */
        }
        .tab-button.active {
            border-bottom-color: #0A1A44;
            color: #0A1A44;
            background-color: #f7f7f7;
        }

        /* Print Styles */@media print {
    /* * NEW RULES FOR PAGE BREAKS AND TABLES */
    @page {
        margin: 0.5cm; /* Reduced margin slightly to gain space */
    }

    h2, h3, h4 {
        page-break-after: avoid; /* Prevent section titles from being left alone */
    }
    
    /* Prevent crucial content blocks (KPI cards, table rows) from splitting */
    tr, .kpi-card, .rounded-lg, .space-y-6 > div {
        page-break-inside: avoid;
    }

    /* Ensure the table header repeats on every new page for long tables */
    thead {
        display: table-header-group;
    }

    /* * AGGRESSIVE OPTIMIZATIONS FOR COMPACTNESS (New) */

    /* 1. Reduce header font size for all major titles */
    header, h1, h2, h3 {
        font-size: 12pt !important; 
        line-height: 1.2 !important;
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }

    /* 2. Reduce general text size for overall compactness */
    body, p, span, td, th {
        font-size: 10pt !important;
        line-height: 1.2 !important;
    }

    /* 3. Ensure KPI cards and content blocks are compact and don't run off */
    .kpi-card, .rounded-lg, .space-y-6 > div {
        padding: 0.5rem !important; /* Reduce padding inside containers */
        margin: 0 !important;       /* Remove extra margins */
        box-shadow: none !important; /* Remove shadows to save ink */
        word-break: break-word;     /* Help long text/numbers fit */
    }

    /* * EXISTING RULES (Keep these as they were) */
    body { background-color: white; padding: 0; }

    /* START: FIX for Change AA - Hiding navigation/tabs for print ONLY */
    .nav-tabs,
    .tabs-container,
    .print-button-container,
    .input-form-control,
    .add-unit-button,
    #statusMessage,
    .footer-section {
        display: none !important;
    }
    /* END: FIX for Change AA */

    /* START: Change AD, AF, AG, AE - New Changes */
    /* Change AD: Top header needs navy blue background. */
    .report-container header { 
        background-color: #0A1A44 !important; /* Set header background to navy */
        color: #0A1A44 !important;
        border-color: #CFAF66 !important;
    }
    .report-container header h2, .report-container header h1 {
        color: white !important;
    }
    .report-container header .text-[#CFAF66] {
        color: #CFAF66 !important; /* Keep the gold text in the header */
    }

    /* Change AF: KPI Cards - Center justify labels and values. */
    .kpi-card, .kpi-card > div, .kpi-card > div > div {
        align-items: center !important;
        text-align: center !important;
        justify-content: center !important;
    }
    .kpi-card p {
        text-align: center !important;
    }
    
    /* Change AG: Remove the header "2. Year 1 Summary & Key Metrics". */
    #summary .print-block {
        display: none !important;
    }
    
    /* Change AE: Remove gap between hidden header and property card */
    .report-container main {
        padding-top: 0 !important; 
    }
    /* Target the property card (which starts with 123 Main St) to remove its top margin */
    #summary .bg-blue-700 {
        margin-top: 0 !important;
        border-radius: 0 !important; /* Remove top border-radius for flush fit */
        margin-bottom: 0.5rem !important; /* Reduce bottom margin */
    }
    /* Also ensure the tab content itself doesn't have excess margin */
    .tab-content {
        padding-top: 0 !important;
    }
    /* END: Change AD, AF, AG, AE */
    
    
    /* ** NEW FIXES FOR TABLE HEADERS (Steps 4-7) ** */

    /* 4. Unit Mix & Income Table Header Shrink (Year 1 Summary) */
    #summary table th {
        white-space: nowrap !important; 
        padding: 3px !important; 
        font-size: 8pt !important;
    }
    
    /* 5. Unit Mix Data Row Shrink - ADDED nowrap */
    #summary table td {
        padding: 3px !important; 
        font-size: 8pt !important;
        white-space: nowrap !important; /* FIX: Prevents Unit Mix data from wrapping */
    }

    /* 6. 5-Year Projections Table Header Shrink */
    #projections table th {
        white-space: nowrap !important;
        padding: 3px !important; 
        font-size: 9pt !important; 
    }
    
    /* 7. 5-Year Projections Data Row Shrink - ADDED nowrap */
    #projections table td {
        padding: 3px !important;
        font-size: 9pt !important;
        white-space: nowrap !important; /* FIX: Prevents 5-Year Projections data from wrapping */
    }
    
    /* ** NEW FIXES FOR TEXT COLOR & KPI WRAPPING ** */
    
    /* Fix 1: Prevent KPI money amounts from wrapping */
    #summaryPurchasePrice,
    #summaryCashInvested {
        white-space: nowrap !important; 
    }

    /* Fix 2: Change Header Text Color to Navy Blue (#0A1A44) */
    .report-container header p, 
    .report-container header span, 
    .report-container header a, 
    .report-container h1, 
    .report-container h2, 
    .report-container main h3, 
    .report-container main p,
    .report-container main .text-lg,
    .report-container main .text-sm
    {
        color: #0A1A44 !important;
    }


    /* ** REST OF YOUR PRINT STYLES (Consolidated) ** */
    .tab-content { 
        display: block !important; 
        padding: 0 !important; 
        margin: 0; 
        width: 100%; 
    }
    #projections,
    #assumptions { 
        page-break-before: always; 
    }
    .print-hidden { 
        display: none !important; 
    }
    .print-block { 
        display: block !important; 
    }
    /* Force tables to be fully visible */
    .overflow-x-auto { 
        overflow-x: visible !important; 
    }
    .min-w-full { 
        min-width: 100% !important; 
    }
} /* Final, essential closing brace */
    </style>
</head>
<body class="p-2 sm:p-5" onload="initializeApp()">

<div class="report-container max-w-7xl mx-auto bg-white rounded-xl overflow-hidden">
<header class="flex flex-col md:flex-row justify-between items-center text-white border-b-4 border-[#CFAF66] py-4 px-6 gap-x-4 header">        <div class="text-center md:text-left leading-tight mb-4 md:mb-0">
            <h2 class="text-lg md:text-xl font-semibold tracking-wide uppercase text-[#0A1A44]">
                Jonathan Sarrow
            </h2>
            <p class="text-sm md:text-base text-[#0A1A44]">
                RealtorÂ® | DRE# 02151231
            </p>
            <p class="text-xs md:text-sm text-[#0A1A44]">
                818-469-5309 Â· jonathan@sheishoperealty.com
            </p>
        </div>

        <div class="text-center md:text-right leading-tight mb-4 md:mb-0 md:flex-1 md:pr-6-[#0A1A44]">
            <h1 class="text-lg md:text-2xl text-[#0A1A44] font-extrabold whitespace-nowrap">
                Multifamily Investment Pro Forma
            </h1>
            <p id="statusMessage" class="mt-1 text-xs font-medium text-[#0A1A44] transition duration-300">
                Enter fields with desired values to save a version
            </p>
        </div>

        <div class="mt-4 md:mt-0 flex items-center print-hidden">
            <button
                onclick="window.print()"
                class="text-gray-800 font-bold py-2 px-4 rounded-lg shadow-lg transition
                        bg-[#CFAF66] hover:bg-[#B08E3C] border border-[#9C7A2F] active:scale-95"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2v-4H6v4zM18 7H6v3h12V7zM19 12h-2v2H7v-2H5c-1.1 0-2 .9-2 2v4c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-4c0-1.1-.9-2-2-2zM19 5c0-.55-.45-1-1-1H6c-.55 0-1 .45-1 1v2h14V5z"/></svg>
                Print/Save PDF
            </button>
        </div>
    </header>

    <div class="nav-tabs border-b border-gray-200 bg-gray-50 flex overflow-x-auto print-hidden">
        <button class="tab-button active flex-shrink-0" onclick="showTab('assumptions')">1. Inputs &amp; Assumptions</button>
        <button class="tab-button flex-shrink-0" onclick="showTab('summary')">2. Year 1 Summary</button>
        <button class="tab-button flex-shrink-0" onclick="showTab('projections')">3. 5-Year Projections</button>
    </div>
    
    <main class="p-4 sm:p-6 lg:p-8">
        <div id="summary" class="tab-content hidden">
            <h1 class="text-2xl font-bold mb-6 text-gray-800 print-block">2. Year 1 Summary &amp; Key Metrics</h1>

            <div class="bg-blue-700 text-white p-5 rounded-lg shadow-2xl mb-6 border-b-4 border-[#CFAF66]">
                <h2 id="summaryPropertyAddress" class="text-2xl sm:text-3xl font-extrabold truncate"></h2>
                <p class="text-blue-200 text-sm mt-1">
                    MLS #:
                    <span id="summaryMLSNumber" class="font-semibold text-white">N/A</span>
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <h2 class="text-xl font-semibold text-gray-800 border-b-2 pb-2 mb-6">
                        Initial Investment &amp; Year 1 Cash Flow Analysis
                    </h2>
                    <div class="space-y-6">
                        <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
                            <h3 class="text-lg font-bold mb-3 text-blue-800">Operating Summary</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm sm:text-base">
                                <p class="font-medium">Gross Potential Income (GPI):</p>
                                <p class="text-right text-gray-700 font-semibold" id="calcGPI"></p>

                                <p class="font-medium">
                                    Vacancy Loss (<span id="vacancyRateDisplay"></span>%):
                                </p>
                                <p class="text-right negative-value font-bold" id="calcVacancy"></p>

                                <p class="font-bold border-t pt-2 text-xl">Effective Gross Income (EGI):</p>
                                <p class="text-right font-extrabold border-t pt-2 text-xl text-blue-700" id="calcEGI"></p>
                            </div>
                        </div>

                        <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
                            <h3 class="text-lg font-bold mb-3 text-red-800">Expenses and Debt Service</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm sm:text-base">
                                <p class="font-medium">Total Operating Expenses (OpEx):</p>
                                <p class="text-right negative-value" id="calcOpEx"></p>

                                <p class="font-bold border-t pt-2 text-xl">Net Operating Income (NOI):</p>
                                <p class="text-right font-extrabold border-t pt-2 text-xl text-green-700" id="calcNOI"></p>

                                <p class="font-medium mt-4 border-t pt-2">Annual Debt Service (P&amp;I):</p>
                                <p class="text-right negative-value mt-4 border-t pt-2" id="calcADS"></p>

                                <p class="font-bold pt-2 text-xl">Annual Cash Flow (CFBT):</p>
                                <p class="text-right font-extrabold pt-2 text-2xl" id="calcCashFlow"></p>
                            </div>
                        </div>

                        <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm overflow-x-auto">
                            <h3 class="text-lg font-bold mb-3 text-gray-700">Unit Mix &amp; Income (Snapshot)</h3>
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-left">Unit Type</th>
                                        <th class="p-2 text-center">Beds</th>
                                        <th class="p-2 text-center">Baths</th>
                                        <th class="p-2 text-right"># Units</th>
                                        <th class="p-2 text-right">Sq. Ft</th>
                                        <th class="p-2 text-right">Monthly Rent ($)</th>
                                        <th class="p-2 text-right">Annual Rent ($)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="unitMixSummaryBody">
                                    </tbody>
                                <tfoot>
                                    <tr class="font-bold bg-gray-50/50">
                                        <td colspan="6" class="p-2 text-right text-base">Gross Annual Rent (GPI)</td>
                                        <td class="p-2 text-right text-lg text-blue-700" id="gpiOutput"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="space-y-6 pt-0 lg:pt-16">
                        <div class="kpi-card bg-blue-50 border-2 border-blue-200">
                            <h3 class="text-xl font-bold text-blue-800">Total Investment</h3>
                            <div class="space-y-2 pt-2">
                                <div class="flex justify-between items-center">
                                    <p class="font-medium text-sm sm:text-base">Purchase Price</p>
                                    <p class="text-xl font-extrabold text-blue-900" id="summaryPurchasePrice"></p>
                                </div>
                                <div class="flex justify-between items-center border-t border-blue-200 pt-2">
                                    <p class="font-bold leading-tight text-blue-700 text-sm sm:text-base">
                                        Total Initial Cash Invested
                                    </p>
                                    <p class="text-2xl font-extrabold text-[#0A1A44]" id="summaryCashInvested"></p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-gray-700 border-b pb-2">Key Performance Indicators</h3>

                            <div class="kpi-card bg-white">
                                <p class="font-semibold text-gray-600">Cash-on-Cash Return (Year 1)</p>
                                <p class="text-4xl font-extrabold text-right" id="summaryCoC"></p>
                                <p class="text-xs text-gray-500 text-right">(Cash Flow Ã· Cash In)</p>
                            </div>

                            <div class="kpi-card bg-white">
                                <p class="font-semibold text-gray-600">Capitalization Rate (Cap Rate)</p>
                                <p class="text-4xl font-extrabold text-right text-purple-700" id="summaryCapRate"></p>
                                <p class="text-xs text-gray-500 text-right">(NOI Ã· Price)</p>
                            </div>

                            <div class="kpi-card bg-white">
                                <p class="font-semibold text-gray-600">Debt Service Coverage Ratio (DSCR)</p>
                                <div class="flex flex-col items-end">
                                    <p class="text-4xl font-extrabold" id="summaryDSCR"></p>
                                    <p class="text-sm mt-1" id="dscrInterpretation"></p>
                                </div>
                                <p class="text-xs text-gray-500 text-right">(NOI Ã· ADS)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div> </div> <div id="projections" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-6">
                3. 5-Year Projections (Includes Growth)
            </h2>

            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-[#0A1A44] text-white sticky top-0">
                        <tr>
                            <th class="p-3 text-left">Metric</th>
                            <th class="p-3 text-center">Year 1 (Initial)</th>
                            <th class="p-3 text-center">Year 2</th>
                            <th class="p-3 text-center">Year 3</th>
                            <th class="p-3 text-center">Year 4</th>
                            <th class="p-3 text-center">Year 5 (Sale)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white" id="projectionTableBody">
                        </tbody>
                </table>
            </div>

            <div class="mt-8 bg-yellow-50 border border-yellow-300 p-5 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold text-yellow-800 mb-4 border-b pb-2">Exit Analysis &amp; Total Return</h3>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 text-sm sm:text-base">
                    <div>
                        <p class="font-medium text-gray-700">Exit Cap Rate:</p>
                        <p class="text-lg font-bold" id="exitCapRate"></p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-700">Projected Sale Price:</p>
                        <p class="text-blue-700 text-lg font-bold" id="projectedSalePrice"></p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-700">Debt Remaining (Year 5):</p>
                        <p class="negative-value text-lg font-bold" id="remainingDebt"></p>
                    </div>
                    <div class="border-t-2 border-yellow-300 pt-3">
                        <p class="font-semibold text-gray-800">Net Sale Proceeds:</p>
                        <p class="text-2xl font-extrabold" id="saleProceeds"></p>
                    </div>
                </div>

                <hr class="my-6 border-yellow-300" />

                <div class="grid grid-cols-2 gap-4 max-w-lg mx-auto">
                    <div>
                        <p class="font-bold text-xl text-gray-800">Equity Multiple:</p>
                        <p class="text-left text-3xl font-extrabold" id="equityMultiple"></p>
                    </div>
                    <div>
                        <p class="font-bold text-xl text-gray-800">Internal Rate of Return (IRR):</p>
                        <p class="text-right text-3xl font-extrabold" id="projectIRR"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="assumptions" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-4">
                1. Core Inputs &amp; Financial Assumptions
            </h2>

            <div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg shadow-sm mb-6">
                <h3 class="text-lg font-bold mb-3 text-indigo-700">Property Identification</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <label class="block text-sm font-medium">Property Address:
                        <input
                            type="text"
                            id="inputPropertyAddress"
                            class="data-input-text mt-1 w-full p-2 border border-indigo-300 rounded-md"
                            value="123 Main St, Anytown, USA"
                            oninput="updateAndCalculate()"
                        />
                    </label>
                    <label class="block text-sm font-medium">MLS Number:
                        <input
                            type="text"
                            id="inputMLSNumber"
                            class="data-input-text mt-1 w-full p-2 border border-indigo-300 rounded-md"
                            value="MLS-1234567"
                            oninput="updateAndCalculate()"
                        />
                    </label>
                </div>
            </div>

            <div class="bg-green-50 border border-green-200 p-4 rounded-lg shadow-sm mb-6 print-hidden">
                <h3 class="text-lg font-bold mb-3 text-green-700">Scenario Management (Local Storage)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium mb-1">Scenario Name</label>
                        <input
                            type="text"
                            id="scenarioNameInput"
                            class="data-input-text w-full p-2 border border-green-300 rounded-md"
                            placeholder="e.g., 8-unit â€“ My Offer"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Saved Scenarios</label>
                        <select
                            id="scenarioSelect"
                            class="data-input-text w-full p-2 border border-green-300 rounded-md cursor-pointer"
                            onchange="window.handleScenarioSelectChange()"
                        >
                            <option value="">-- None loaded --</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <button
                            type="button"
                            onclick="window.saveScenarioFromUI()"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 active:scale-95"
                        >
                            ðŸ’¾ Save Scenario
                        </button>
                        <button
                            type="button"
                            onclick="window.deleteSelectedScenario()"
                            class="bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 active:scale-95"
                        >
                            ðŸ—‘ Delete
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm mb-6 overflow-x-auto">
                <h3 class="text-lg font-bold mb-3 text-blue-800">Unit Mix (Inputs)</h3>
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-blue-100">
                        <tr>
                            <th class="p-2 text-left w-32">Unit Type</th>
                            
                            <th class="p-2 text-center font-bold w-16 text-xs text-gray-700 uppercase tracking-wider">Beds</th>
                            <th class="p-2 text-center font-bold w-16 text-xs text-gray-700 uppercase tracking-wider">Baths</th>
                            <th class="p-2 text-center font-bold w-16 text-xs text-gray-700 uppercase tracking-wider"># UNITS</th>
                            <th class="p-2 text-center font-bold w-20 text-xs text-gray-700 uppercase tracking-wider">SQ. FT</th>
                            
                            <th class="p-2 text-right w-24">Monthly Rent ($)</th>
                            <th class="p-2 text-right w-24">Annual Rent ($)</th>
                            <th class="p-2 text-center input-form-control print-hidden w-16">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="unitMixBody">
                        </tbody>
                    <tfoot>
                        <tr class="font-bold bg-blue-100/50">
                            <td colspan="5" class="p-2 text-right text-base">Gross Annual Rent (GPI)</td>
                            <td class="p-2 text-right text-lg text-blue-700" id="gpiInputTabOutput"></td>
                            <td class="p-2 input-form-control text-center print-hidden">
                                <button
                                    onclick="addUnit()"
                                    class="add-unit-button bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-3 rounded-md transition duration-150 active:scale-95 whitespace-nowrap"
                                >
                                    + Add Unit
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">Acquisition Details</h3>
                    <div class="space-y-3 text-sm">
                        <label class="block font-medium">Purchase Price ($):
                            <input
                                type="number"
                                id="inputPurchasePrice"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="1200000"
                                oninput="updateAndCalculate()"
                                min="1"
                            />
                        </label>
                        <label class="block font-medium">Down Payment (%):
                            <input
                                type="number"
                                id="inputDownPaymentPct"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="20"
                                oninput="updateAndCalculate()"
                                min="1"
                                max="100"
                                step="0.5"
                            />
                        </label>
                        <label class="block font-medium">Closing Costs ($):
                            <input
                                type="number"
                                id="inputClosingCosts"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="20000"
                                oninput="updateAndCalculate()"
                                min="0"
                            />
                        </label>
                        <label class="block font-medium">Initial CapEx/Repairs ($):
                            <input
                                type="number"
                                id="inputCapEx"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="10000"
                                oninput="updateAndCalculate()"
                                min="0"
                            />
                        </label>
                        <hr class="my-2 border-gray-300" />
                        <p class="font-bold pt-1 flex justify-between items-center text-base">
                            Total Cash Invested:
                            <span class="text-blue-700 text-lg" id="inputCashInvested"></span>
                        </p>
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">Loan Parameters</h3>
                    <div class="space-y-3 text-sm">
                        <p class="flex justify-between font-medium">
                            Loan Amount:
                            <span class="calc-cell text-base font-semibold" id="inputLoanAmount"></span>
                        </p>
                        <label class="block font-medium">Interest Rate (Annual %):
                            <input
                                type="number"
                                id="inputInterestRate"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="6.5"
                                oninput="updateAndCalculate()"
                                min="0.1"
                                step="0.1"
                            />
                        </label>
                        <label class="block font-medium">Loan Term (Years):
                            <input
                                type="number"
                                id="inputLoanTerm"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="30"
                                oninput="updateAndCalculate()"
                                min="5"
                                step="1"
                            />
                        </label>
                        <hr class="my-2 border-gray-300" />
                        <p class="flex justify-between font-medium">
                            Monthly Payment (P&amp;I):
                            <span class="calc-cell font-bold text-red-600 text-lg" id="inputMonthlyPmt"></span>
                        </p>
                        <p class="flex justify-between font-medium">
                            Annual Debt Service (ADS):
                            <span class="calc-cell text-base font-semibold" id="inputADS"></span>
                        </p>
                        <p class="font-bold pt-1 flex justify-between items-center text-base">
                            Total Payments (Loan Term):
                            <span class="text-red-600 text-lg" id="inputTotalPayments"></span>
                        </p>
                    </div>
                </div>

                <div class="bg-yellow-50 border border-yellow-300 p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">Growth &amp; Exit Assumptions</h3>
                    <div class="space-y-3 text-sm">
                        <label class="block font-medium">Rent Growth (Annual %):
                            <input
                                type="number"
                                id="inputRentGrowth"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="3"
                                oninput="updateAndCalculate()"
                                step="0.1"
                                min="0"
                            />
                        </label>
                        <label class="block font-medium">Expense Growth (Annual %):
                            <input
                                type="number"
                                id="inputExpenseGrowth"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="3"
                                oninput="updateAndCalculate()"
                                step="0.1"
                                min="0"
                            />
                        </label>
                        <label class="block font-medium">Exit Year (Years):
                            <input
                                type="number"
                                id="inputExitYear"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="5"
                                oninput="updateAndCalculate()"
                                min="1"
                            />
                        </label>
                        <label class="block font-medium">Exit Cap Rate (%):
                            <input
                                type="number"
                                id="inputExitCapRate"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="6.5"
                                oninput="updateAndCalculate()"
                                step="0.1"
                                min="0.1"
                            />
                        </label>
                        <label class="block font-medium">Sale Costs (% of Sale Price):
                            <input
                                type="number"
                                id="inputSaleCostsPct"
                                class="data-input mt-1 w-full p-2 border border-gray-300 rounded-md text-right"
                                value="5"
                                oninput="updateAndCalculate()"
                                step="0.1"
                                min="0"
                                max="100"
                            />
                        </label>
                    </div>
                </div>
            </div>

            <div class="bg-red-50 border border-red-200 p-4 rounded-lg shadow-sm mt-6">
                <h3 class="text-lg font-bold mb-3 text-red-700">Annual Expenses (Year 1)</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-sm">
                    <label class="block font-medium">Vacancy Rate (%):
                        <input
                            type="number"
                            id="inputVacancyRate"
                            class="data-input mt-1 w-full p-2 border border-red-300 rounded-md text-right"
                            value="3"
                            oninput="updateAndCalculate()"
                            step="0.1"
                            min="0"
                            max="100"
                        />
                    </label>
                    <label class="block font-medium">Property Tax ($):
                        <input
                            type="number"
                            id="inputPropertyTax"
                            class="data-input mt-1 w-full p-2 border border-red-300 rounded-md text-right"
                            value="15000"
                            oninput="updateAndCalculate()"
                            min="0"
                        />
                    </label>
                    <label class="block font-medium">Insurance ($):
                        <input
                            type="number"
                            id="inputInsurance"
                            class="data-input mt-1 w-full p-2 border border-red-300 rounded-md text-right"
                            value="3500"
                            oninput="updateAndCalculate()"
                            min="0"
                        />
                    </label>
                    <label class="block font-medium">Management Fee (% of EGI):
                        <input
                            type="number"
                            id="inputManagementFeePct"
                            class="data-input mt-1 w-full p-2 border border-red-300 rounded-md text-right"
                            value="8"
                            oninput="updateAndCalculate()"
                            step="0.1"
                            min="0"
                            max="100"
                        />
                    </label>
                    <label class="block font-medium">Utilities ($):
                        <input
                            type="number"
                            id="inputUtilities"
                            class="data-input mt-1 w-full p-2 border border-red-300 rounded-md text-right"
                            value="5000"
                            oninput="updateAndCalculate()"
                            min="0"
                        />
                    </label>
                    <label class="block font-medium">Repairs & Maintenance ($):
                        <input
                            type="number"
                            id="inputRepairs"
                            class="data-input mt-1 w-full p-2 border border-red-300 rounded-md text-right"
                            value="4000"
                            oninput="updateAndCalculate()"
                            min="0"
                        />
                    </label>
                    <label class="block font-medium">Capital Reserves ($/Year):
                        <input
                            type="number"
                            id="inputReserves"
                            class="data-input mt-1 w-full p-2 border border-red-300 rounded-md text-right"
                            value="2000"
                            oninput="updateAndCalculate()"
                            min="0"
                        />
                    </label>
                    <label class="block font-medium">Other Operating Expenses ($):
                        <input
                            type="number"
                            id="inputOtherOpEx"
                            class="data-input mt-1 w-full p-2 border border-red-300 rounded-md text-right"
                            value="500"
                            oninput="updateAndCalculate()"
                            min="0"
                        />
                    </label>
                </div>
                <hr class="my-4 border-red-300" />
                <p class="font-bold flex justify-between items-center text-base">
                    Total Annual Operating Expenses (OpEx):
                    <span class="text-red-700 text-lg" id="inputTotalOpEx"></span>
                </p>
            </div>
        </div> </main>
    
    <footer class="footer-section bg-gray-100 p-4 text-center text-xs text-gray-500 border-t print-hidden">
        Disclaimer: This pro forma tool provides estimates based on your inputs and is for informational purposes only. Consult with a financial professional before making investment decisions.
    </footer>
</div>

<script>
    // Global data structure for the pro forma
    let data = {
        // Property Details
        propertyAddress: '123 Main St, Anytown, USA',
        mlsNumber: 'MLS-1234567',
        
        // Unit Mix (Example Initial Data)
        unitMix: [
            { id: 1, type: '2 Bed / 2 Bath', beds: 2, baths: 2, count: 4, sqft: 900, rent: 1400 },
            { id: 2, type: '1 Bed / 1 Bath', beds: 1, baths: 1, count: 4, sqft: 750, rent: 1200 },
        ],
        
        // Acquisition/Loan
        purchasePrice: 1200000,
        downPaymentPct: 20,
        closingCosts: 20000,
        initialCapEx: 10000,
        interestRate: 6.5, // Annual %
        loanTerm: 30, // Years
        
        // Expenses
        vacancyRate: 3, // % of GPI
        propertyTax: 15000,
        insurance: 3500,
        managementFeePct: 8, // % of EGI
        utilities: 5000,
        repairs: 4000,
        reserves: 2000,
        otherOpEx: 500,
        
        // Growth & Exit
        rentGrowth: 3, // Annual %
        expenseGrowth: 3, // Annual %
        exitYear: 5,
        exitCapRate: 6.5, // %
        saleCostsPct: 5, // %
        
        // Calculated results (initial placeholder)
        calculations: {},
    };

    // --- Core Calculation Functions ---

    /**
     * Calculates the fixed monthly payment (P&I) for an amortizing loan.
     * @param {number} principal - The loan amount.
     * @param {number} annualRate - The annual interest rate (e.g., 0.065 for 6.5%).
     * @param {number} years - The loan term in years.
     * @returns {number} The monthly payment.
     */
    function calculateMonthlyPayment(principal, annualRate, years) {
        if (principal <= 0 || annualRate <= 0 || years <= 0) return 0;

        const rate = annualRate / 12; // Monthly rate
        const payments = years * 12; // Total number of payments

        // M = P [ r(1 + r)^n / ((1 + r)^n - 1) ]
        return principal * (rate * Math.pow(1 + rate, payments)) / (Math.pow(1 + rate, payments) - 1);
    }

    /**
     * Calculates the remaining balance of a loan after a specific number of years.
     * @param {number} principal - Initial loan amount.
     * @param {number} annualRate - Annual interest rate (as a decimal).
     * @param {number} termYears - Total loan term in years.
     * @param {number} currentYear - The year for which to calculate the balance (1-indexed).
     * @returns {number} The remaining loan balance.
     */
    function calculateRemainingBalance(principal, annualRate, termYears, currentYear) {
        if (principal <= 0 || annualRate <= 0 || termYears <= 0 || currentYear <= 0) return 0;
        if (currentYear >= termYears) return 0;

        const monthlyRate = annualRate / 12;
        const totalPayments = termYears * 12;
        const paymentsMade = currentYear * 12;

        const monthlyPayment = calculateMonthlyPayment(principal, annualRate, termYears);
        
        // Remaining Balance = P * [(1+r)^n - (1+r)^p] / [(1+r)^n - 1]
        const remainingBalance = principal * (Math.pow(1 + monthlyRate, totalPayments) - Math.pow(1 + monthlyRate, paymentsMade)) / (Math.pow(1 + monthlyRate, totalPayments) - 1);

        // Ensure result is not negative due to floating point arithmetic
        return Math.max(0, remainingBalance);
    }

    /**
     * Performs all core calculations for a single year (Year 1 for summary).
     * @param {object} inputData - The data object.
     * @param {number} year - The current year (1-indexed).
     * @returns {object} Calculated financial metrics for the year.
     */
    function calculateProForma(inputData, year = 1) {
        // Constants (from inputs)
        const P = inputData.purchasePrice;
        const DP_Pct = inputData.downPaymentPct / 100;
        const Closing_Costs = inputData.closingCosts;
        const Initial_CapEx = inputData.initialCapEx;
        const Int_Rate = inputData.interestRate / 100;
        const Loan_Term = inputData.loanTerm;
        const Vacancy_Rate = inputData.vacancyRate / 100;
        const Mgmt_Fee_Pct = inputData.managementFeePct / 100;

        // Apply growth rates for years > 1
        const rentGrowthFactor = Math.pow(1 + (inputData.rentGrowth / 100), year - 1);
        const expenseGrowthFactor = Math.pow(1 + (inputData.expenseGrowth / 100), year - 1);

        // 1. Income
        let grossAnnualRent = inputData.unitMix.reduce((total, unit) => 
            total + (unit.rent * 12 * unit.count * rentGrowthFactor), 0
        );
        const GPI = grossAnnualRent;
        const Vacancy_Loss = GPI * Vacancy_Rate * -1; // Negative value
        const EGI = GPI + Vacancy_Loss;

        // 2. Expenses (Applying Expense Growth)
        const Tax = inputData.propertyTax * expenseGrowthFactor;
        const Insurance = inputData.insurance * expenseGrowthFactor;
        const Utilities = inputData.utilities * expenseGrowthFactor;
        const Repairs = inputData.repairs * expenseGrowthFactor;
        const Reserves = inputData.reserves * expenseGrowthFactor;
        const OtherOpEx = inputData.otherOpEx * expenseGrowthFactor;
        
        const Management_Fee_Calc = EGI * Mgmt_Fee_Pct;
        
        const Total_OpEx = (Tax + Insurance + Utilities + Repairs + Reserves + OtherOpEx + Management_Fee_Calc) * -1; // Negative value for display

        // 3. Net Operating Income (NOI)
        const NOI = EGI + Total_OpEx;

        // 4. Debt Service
        const Loan_Amount = P * (1 - DP_Pct);
        const Monthly_Pmt = calculateMonthlyPayment(Loan_Amount, Int_Rate, Loan_Term);
        const ADS = Monthly_Pmt * 12 * -1; // Annual Debt Service (negative for display)

        // 5. Cash Flow
        const Cash_Flow = NOI + ADS;

        // 6. Investment Metrics (Year 1 Only)
        let Cash_Invested = 0;
        let CoC_Rate = 0;
        let Cap_Rate = 0;
        let DSCR = 0;
        
        if (year === 1) {
            Cash_Invested = P * DP_Pct + Closing_Costs + Initial_CapEx;
            CoC_Rate = Cash_Invested > 0 ? (Cash_Flow / Cash_Invested) : 0;
            Cap_Rate = P > 0 ? (NOI / P) : 0;
            DSCR = ADS !== 0 ? (NOI / (ADS * -1)) : 0; // Use positive ADS for DSCR calc
        }

        // 7. Loan Balance (for Projections)
        const Remaining_Debt = calculateRemainingBalance(Loan_Amount, Int_Rate, Loan_Term, year);

        return {
            GPI,
            Vacancy_Loss,
            EGI,
            Total_OpEx,
            NOI,
            Loan_Amount: Loan_Amount,
            Monthly_Pmt,
            ADS,
            Cash_Flow,
            Remaining_Debt,

            // Year 1 Specific
            Cash_Invested,
            CoC_Rate,
            Cap_Rate,
            DSCR,
        };
    }
    
    /**
     * Calculates the entire 5-year projection and final exit metrics.
     * @param {object} inputData - The data object.
     * @returns {object} Object containing projection and final metrics.
     */
    function calculateProjections(inputData) {
        const projectionYears = [];
        const cashFlows = [inputData.calculations.year1.Cash_Invested * -1]; // Initial investment is cash outflow

        // 1. Calculate each year's cash flow
        for (let y = 1; y <= inputData.exitYear; y++) {
            const result = calculateProForma(inputData, y);
            projectionYears.push(result);
            cashFlows.push(result.Cash_Flow); // CFBT is cash inflow/outflow
        }

        // 2. Exit Analysis (Year 'Exit_Year')
        const Exit_Year_Metrics = projectionYears[inputData.exitYear - 1]; // 0-indexed
        
        const Exit_Cap_Rate = inputData.exitCapRate / 100;
        const Year_of_Sale_NOI = Exit_Year_Metrics.NOI;

        let Projected_Sale_Price = 0;
        if (Exit_Cap_Rate > 0) {
            Projected_Sale_Price = Year_of_Sale_NOI / Exit_Cap_Rate;
        }

        const Remaining_Debt = Exit_Year_Metrics.Remaining_Debt;
        const Sale_Costs_Pct = inputData.saleCostsPct / 100;
        const Sale_Costs = Projected_Sale_Price * Sale_Costs_Pct;
        
        const Net_Sale_Proceeds = Projected_Sale_Price - Remaining_Debt - Sale_Costs;
        
        // 3. Update the last year's cash flow with the sale proceeds
        const Final_Year_CF = projectionYears[projectionYears.length - 1].Cash_Flow + Net_Sale_Proceeds;
        cashFlows[cashFlows.length - 1] = Final_Year_CF; // The exit year cash flow is the regular CFBT + Sale Proceeds
        
        // 4. Calculate IRR (Internal Rate of Return)
        // Uses a third-party implementation (like financial.js or simplified version)
        // For simplicity and dependency avoidance, we will use a common approximation function here
        const IRR = calculateIRR(cashFlows);
        
        // 5. Calculate Equity Multiple
        const Total_Cash_In = inputData.calculations.year1.Cash_Invested;
        const Total_Cash_Out = cashFlows.reduce((sum, cf) => sum + Math.max(0, cf), 0); // Sum of positive cash flows (including sale)
        const Equity_Multiple = Total_Cash_In > 0 ? Total_Cash_Out / Total_Cash_In : 0;
        
        return {
            projectionYears,
            Projected_Sale_Price,
            Remaining_Debt,
            Net_Sale_Proceeds,
            Equity_Multiple,
            IRR,
            cashFlows, // For debugging/display
        };
    }
    
    // Simple iterative IRR calculator (approximate)
    function calculateIRR(cashFlows, guess = 0.1) {
        const maxIterations = 100;
        const tolerance = 0.0001;

        function npv(rate) {
            let sum = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                sum += cashFlows[i] / Math.pow(1 + rate, i);
            }
            return sum;
        }

        let rate = guess;
        for (let i = 0; i < maxIterations; i++) {
            const y = npv(rate);
            const yPrime = (npv(rate + tolerance) - y) / tolerance;
            const newRate = rate - y / yPrime;

            if (Math.abs(newRate - rate) < tolerance) {
                return newRate;
            }
            rate = newRate;
        }

        return rate; // Best guess after max iterations
    }

    // --- Data Management and UI Functions ---

    /**
     * Main function to update data from inputs, recalculate, and refresh UI.
     */
    function updateAndCalculate() {
        // 1. Update Core Inputs
        data.propertyAddress = document.getElementById('inputPropertyAddress').value;
        data.mlsNumber = document.getElementById('inputMLSNumber').value;
        data.purchasePrice = parseFloat(document.getElementById('inputPurchasePrice').value) || 0;
        data.downPaymentPct = parseFloat(document.getElementById('inputDownPaymentPct').value) || 0;
        data.closingCosts = parseFloat(document.getElementById('inputClosingCosts').value) || 0;
        data.initialCapEx = parseFloat(document.getElementById('inputCapEx').value) || 0;
        data.interestRate = parseFloat(document.getElementById('inputInterestRate').value) || 0;
        data.loanTerm = parseFloat(document.getElementById('inputLoanTerm').value) || 0;
        data.vacancyRate = parseFloat(document.getElementById('inputVacancyRate').value) || 0;
        data.propertyTax = parseFloat(document.getElementById('inputPropertyTax').value) || 0;
        data.insurance = parseFloat(document.getElementById('inputInsurance').value) || 0;
        data.managementFeePct = parseFloat(document.getElementById('inputManagementFeePct').value) || 0;
        data.utilities = parseFloat(document.getElementById('inputUtilities').value) || 0;
        data.repairs = parseFloat(document.getElementById('inputRepairs').value) || 0;
        data.reserves = parseFloat(document.getElementById('inputReserves').value) || 0;
        data.otherOpEx = parseFloat(document.getElementById('inputOtherOpEx').value) || 0;
        data.rentGrowth = parseFloat(document.getElementById('inputRentGrowth').value) || 0;
        data.expenseGrowth = parseFloat(document.getElementById('inputExpenseGrowth').value) || 0;
        data.exitYear = parseInt(document.getElementById('inputExitYear').value) || 1;
        data.exitCapRate = parseFloat(document.getElementById('inputExitCapRate').value) || 0;
        data.saleCostsPct = parseFloat(document.getElementById('inputSaleCostsPct').value) || 0;

        // 2. Update Unit Mix (read from inputs)
        updateUnitMixFromInputs();

        // 3. Recalculate everything
        data.calculations.year1 = calculateProForma(data, 1);
        data.calculations.projections = calculateProjections(data);

        // 4. Render UI
        renderInputTab();
        renderSummaryTab();
        renderProjectionsTab();
        
        // Save to local storage (optional)
        saveCurrentDataToLocal();
    }
    
    // Utility to format numbers as currency ($1,234,567) or percentage (12.34%)
    const formatCurrency = (amount, decimals = 0) => {
        if (typeof amount !== 'number') return '-';
        return amount.toLocaleString('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
        });
    };
    const formatPercent = (rate, decimals = 2) => {
        if (typeof rate !== 'number') return '-';
        return (rate * 100).toFixed(decimals) + '%';
    };
    const formatRatio = (ratio, decimals = 2) => {
        if (typeof ratio !== 'number') return '-';
        return ratio.toFixed(decimals) + 'x';
    };

    /**
     * Renders the Unit Mix inputs on the Assumptions tab.
     * Also updates other simple calculated cells on the same tab.
     */
    function renderInputTab() {
        const mixBody = document.getElementById('unitMixBody');
        mixBody.innerHTML = '';
        
        let totalGPI = 0;

        data.unitMix.forEach((unit, index) => {
            const annualRent = unit.rent * 12 * unit.count;
            totalGPI += annualRent;
            
            const row = document.createElement('tr');
            row.classList.add('hover:bg-blue-50');
            row.innerHTML = `
                <td class="p-2">
                    <input type="text" value="${unit.type}" oninput="data.unitMix[${index}].type=this.value; updateAndCalculate();" 
                           class="data-input-text w-full border-b border-blue-200" />
                </td>
                <td class="p-2 text-center">
                    <input type="number" value="${unit.beds}" oninput="data.unitMix[${index}].beds=parseInt(this.value)||0; updateAndCalculate();" 
                           class="data-input w-full text-center border-b border-blue-200" min="0" />
                </td>
                <td class="p-2 text-center">
                    <input type="number" value="${unit.baths}" oninput="data.unitMix[${index}].baths=parseInt(this.value)||0; updateAndCalculate();" 
                           class="data-input w-full text-center border-b border-blue-200" min="0" step="0.5" />
                </td>
                <td class="p-2 text-center">
                    <input type="number" value="${unit.count}" oninput="data.unitMix[${index}].count=parseInt(this.value)||0; updateAndCalculate();" 
                           class="data-input w-full text-center border-b border-blue-200" min="0" />
                </td>
                <td class="p-2 text-center">
                    <input type="number" value="${unit.sqft}" oninput="data.unitMix[${index}].sqft=parseInt(this.value)||0; updateAndCalculate();" 
                           class="data-input w-full text-center border-b border-blue-200" min="0" />
                </td>
                <td class="p-2 text-right">
                    <input type="number" value="${unit.rent}" oninput="data.unitMix[${index}].rent=parseInt(this.value)||0; updateAndCalculate();" 
                           class="data-input w-full border-b border-blue-200" min="0" />
                </td>
                <td class="p-2 text-right calc-cell">${formatCurrency(annualRent)}</td>
                <td class="p-2 text-center input-form-control print-hidden">
                    <button onclick="removeUnit(${unit.id})" class="text-red-500 hover:text-red-700 text-sm font-semibold">
                        Remove
                    </button>
                </td>
            `;
            mixBody.appendChild(row);
        });
        
        document.getElementById('gpiInputTabOutput').textContent = formatCurrency(totalGPI);
        
        // Update simple calculations on the inputs tab
        const year1 = data.calculations.year1;
        const totalPayments = year1.Monthly_Pmt * 12 * data.loanTerm;
        const cashInvested = year1.Cash_Invested;
        
        document.getElementById('inputLoanAmount').textContent = formatCurrency(year1.Loan_Amount);
        document.getElementById('inputMonthlyPmt').textContent = formatCurrency(year1.Monthly_Pmt);
        document.getElementById('inputADS').textContent = formatCurrency(year1.ADS * -1); // Display positive
        document.getElementById('inputTotalPayments').textContent = formatCurrency(totalPayments);
        document.getElementById('inputCashInvested').textContent = formatCurrency(cashInvested);
        document.getElementById('inputTotalOpEx').textContent = formatCurrency(year1.Total_OpEx * -1); // Display positive
    }
    
    /**
     * Reads values from the dynamically created unit mix inputs and updates the data object.
     * This is an alternative to oninput for robustness, but here it acts as a cleanup
     * wrapper before re-calculating.
     */
    function updateUnitMixFromInputs() {
        // Since we rebuild the table on every renderInputTab, the data.unitMix is the source of truth.
        // We ensure data.unitMix is updated inside the render loop's oninput, so this is mainly a safeguard.
        // The structure ensures only valid numbers/text are placed back into data.unitMix.
        
        // This is where you might also handle other elements if they weren't updated via oninput
    }
    
    /**
     * Adds a new, blank unit type to the data model.
     */
    function addUnit() {
        const newId = data.unitMix.length > 0 ? Math.max(...data.unitMix.map(u => u.id)) + 1 : 1;
        data.unitMix.push({
            id: newId, 
            type: 'New Unit Type', 
            beds: 0, 
            baths: 0, 
            count: 0, 
            sqft: 0, 
            rent: 0 
        });
        updateAndCalculate();
    }

    /**
     * Removes a unit type by its ID.
     * @param {number} id - The ID of the unit type to remove.
     */
    function removeUnit(id) {
        data.unitMix = data.unitMix.filter(unit => unit.id !== id);
        updateAndCalculate();
    }
    
    /**
     * Renders the Summary tab content.
     */
    function renderSummaryTab() {
        const year1 = data.calculations.year1;
        
        // Property Header
        document.getElementById('summaryPropertyAddress').textContent = data.propertyAddress;
        document.getElementById('summaryMLSNumber').textContent = data.mlsNumber || 'N/A';
        
        // Operating Summary
        document.getElementById('calcGPI').textContent = formatCurrency(year1.GPI);
        document.getElementById('vacancyRateDisplay').textContent = data.vacancyRate.toFixed(2);
        document.getElementById('calcVacancy').textContent = formatCurrency(year1.Vacancy_Loss);
        document.getElementById('calcEGI').textContent = formatCurrency(year1.EGI);
        
        // Expenses and Debt Service
        document.getElementById('calcOpEx').textContent = formatCurrency(year1.Total_OpEx);
        document.getElementById('calcNOI').textContent = formatCurrency(year1.NOI);
        document.getElementById('calcADS').textContent = formatCurrency(year1.ADS);
        
        const cashFlowElement = document.getElementById('calcCashFlow');
        cashFlowElement.textContent = formatCurrency(year1.Cash_Flow);
        cashFlowElement.classList.toggle('positive-return', year1.Cash_Flow > 0);
        cashFlowElement.classList.toggle('negative-value', year1.Cash_Flow < 0);
        
        // Investment Metrics
        document.getElementById('summaryPurchasePrice').textContent = formatCurrency(data.purchasePrice);
        document.getElementById('summaryCashInvested').textContent = formatCurrency(year1.Cash_Invested);

        const cocElement = document.getElementById('summaryCoC');
        cocElement.textContent = formatPercent(year1.CoC_Rate);
        cocElement.classList.toggle('positive-return', year1.CoC_Rate > 0);
        cocElement.classList.toggle('negative-value', year1.CoC_Rate < 0);
        
        document.getElementById('summaryCapRate').textContent = formatPercent(year1.Cap_Rate);
        
        const dscrElement = document.getElementById('summaryDSCR');
        const dscrInterpretation = document.getElementById('dscrInterpretation');
        dscrElement.textContent = formatRatio(year1.DSCR, 2);
        
        if (year1.DSCR >= 1.2) {
            dscrInterpretation.textContent = 'Excellent (Low Risk)';
            dscrInterpretation.className = 'text-sm mt-1 text-green-700';
        } else if (year1.DSCR >= 1.0) {
            dscrInterpretation.textContent = 'Acceptable (Moderate Risk)';
            dscrInterpretation.className = 'text-sm mt-1 text-yellow-700';
        } else {
            dscrInterpretation.textContent = 'Needs Improvement (High Risk)';
            dscrInterpretation.className = 'text-sm mt-1 text-red-700';
        }
        
        // Unit Mix Snapshot for Summary
        renderUnitMixSummary();
    }

    /**
     * Renders the Unit Mix summary table.
     */
    function renderUnitMixSummary() {
        const summaryBody = document.getElementById('unitMixSummaryBody');
        summaryBody.innerHTML = '';
        
        let totalGPI = 0;

        data.unitMix.forEach(unit => {
            const annualRent = unit.rent * 12 * unit.count;
            totalGPI += annualRent;

            const row = document.createElement('tr');
            row.classList.add('hover:bg-gray-50');
            row.innerHTML = `
                <td class="p-2 text-left">${unit.type}</td>
                <td class="p-2 text-center">${unit.beds}</td>
                <td class="p-2 text-center">${unit.baths}</td>
                <td class="p-2 text-right">${unit.count}</td>
                <td class="p-2 text-right">${unit.sqft.toLocaleString()}</td>
                <td class="p-2 text-right">${formatCurrency(unit.rent, 0)}</td>
                <td class="p-2 text-right">${formatCurrency(annualRent, 0)}</td>
            `;
            summaryBody.appendChild(row);
        });
        
        document.getElementById('gpiOutput').textContent = formatCurrency(totalGPI);
    }

    /**
     * Renders the 5-Year Projections tab.
     */
    function renderProjectionsTab() {
        const projections = data.calculations.projections;
        const years = projections.projectionYears;
        const tableBody = document.getElementById('projectionTableBody');
        tableBody.innerHTML = '';
        
        // Define rows for the projection table
        const metrics = [
            { label: 'Gross Potential Income (GPI)', key: 'GPI', format: formatCurrency },
            { label: 'Effective Gross Income (EGI)', key: 'EGI', format: formatCurrency },
            { label: 'Total Operating Expenses (OpEx)', key: 'Total_OpEx', format: formatCurrency, negative: true },
            { label: 'Net Operating Income (NOI)', key: 'NOI', format: formatCurrency, bold: true, color: 'text-green-700' },
            { label: 'Annual Debt Service (ADS)', key: 'ADS', format: formatCurrency, negative: true },
            { label: 'Cash Flow Before Tax (CFBT)', key: 'Cash_Flow', format: formatCurrency, bold: true, colorFunc: (val) => val >= 0 ? 'text-blue-700' : 'negative-value' },
            { label: 'Cash-on-Cash Return (%)', key: 'CoC_Rate', format: formatPercent, colorFunc: (val) => val >= 0 ? 'positive-return' : 'negative-value' },
            { label: 'Remaining Debt', key: 'Remaining_Debt', format: formatCurrency, footer: true, negative: true },
        ];
        
        metrics.forEach(metric => {
            const row = document.createElement('tr');
            row.classList.add('hover:bg-gray-50', 'text-sm');
            if (metric.bold) row.classList.add('font-semibold', 'bg-gray-50');

            let rowContent = `<td class="p-2 text-left">${metric.label}</td>`;
            
            for (let y = 0; y < data.exitYear; y++) {
                const value = years[y][metric.key];
                const displayValue = metric.negative ? value * -1 : value;
                
                let cellClass = 'p-2 text-right';
                if (metric.bold) cellClass += ' font-extrabold';
                if (metric.color) cellClass += ` ${metric.color}`;
                if (metric.colorFunc) cellClass += ` ${metric.colorFunc(value)}`;
                
                rowContent += `<td class="${cellClass}">${metric.format(displayValue, metric.key === 'CoC_Rate' ? 2 : 0)}</td>`;
            }
            
            // Fill remaining columns if Exit Year < 5
            for (let y = data.exitYear; y < 5; y++) {
                rowContent += `<td class="p-2 text-center text-gray-400">-</td>`;
            }

            row.innerHTML = rowContent;
            tableBody.appendChild(row);
        });

        // Exit Analysis details
        document.getElementById('exitCapRate').textContent = formatPercent(data.exitCapRate / 100);
        document.getElementById('projectedSalePrice').textContent = formatCurrency(projections.Projected_Sale_Price);
        document.getElementById('remainingDebt').textContent = formatCurrency(projections.Remaining_Debt * -1); // Display as negative outflow
        
        const netProceedsElement = document.getElementById('saleProceeds');
        netProceedsElement.textContent = formatCurrency(projections.Net_Sale_Proceeds);
        netProceedsElement.classList.toggle('positive-return', projections.Net_Sale_Proceeds > 0);
        netProceedsElement.classList.toggle('negative-value', projections.Net_Sale_Proceeds < 0);

        // Final Returns
        document.getElementById('equityMultiple').textContent = projections.Equity_Multiple.toFixed(2) + 'x';
        
        const irrElement = document.getElementById('projectIRR');
        irrElement.textContent = formatPercent(projections.IRR);
        irrElement.classList.toggle('positive-return', projections.IRR > 0);
        irrElement.classList.toggle('negative-value', projections.IRR < 0);
    }

    /**
     * Switches between tabs.
     * @param {string} tabId - The ID of the tab content to show ('assumptions', 'summary', 'projections').
     */
    function showTab(tabId) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });

        // Deactivate all buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
            button.classList.remove('bg-gray-200');
        });

        // Show the selected tab content
        const activeTab = document.getElementById(tabId);
        if (activeTab) {
            activeTab.classList.remove('hidden');
        }

        // Activate the corresponding button
        const activeBtn = document.querySelector(`.tab-button[onclick*="'${tabId}'"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
    
    // --- Local Storage and Scenario Management ---

    const LOCAL_STORAGE_KEY = 'sarrow-proforma-scenarios';
    
    /**
     * Saves the current data object as a named scenario to local storage.
     */
    window.saveScenarioFromUI = function() {
        const scenarioName = document.getElementById('scenarioNameInput').value.trim();
        if (!scenarioName) {
            alert('Please enter a name for the scenario.');
            return;
        }

        const scenarios = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
        
        // Ensure data is up-to-date before saving
        updateAndCalculate(); 

        // Deep copy of the data object
        scenarios[scenarioName] = JSON.parse(JSON.stringify(data));
        
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(scenarios));
        populateScenarioSelect(scenarioName);
        alert(`Scenario "${scenarioName}" saved successfully.`);
        document.getElementById('statusMessage').textContent = `Scenario "${scenarioName}" saved.`;
    };
    
    /**
     * Loads the selected scenario from local storage.
     */
    window.handleScenarioSelectChange = function() {
        const select = document.getElementById('scenarioSelect');
        const scenarioName = select.value;
        if (!scenarioName) {
            // Option "-- None loaded --" selected
            return; 
        }

        const scenarios = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
        const scenarioData = scenarios[scenarioName];

        if (scenarioData) {
            // Load the saved data
            data = scenarioData;
            // Update all the input fields to reflect the loaded data
            loadDataToInputs(data);
            // Recalculate and re-render everything
            updateAndCalculate(); 
            document.getElementById('scenarioNameInput').value = scenarioName;
            document.getElementById('statusMessage').textContent = `Scenario "${scenarioName}" loaded.`;
        }
    };
    
    /**
     * Deletes the currently selected scenario.
     */
    window.deleteSelectedScenario = function() {
        const select = document.getElementById('scenarioSelect');
        const scenarioName = select.value;
        if (!scenarioName) {
            alert('Please select a scenario to delete.');
            return;
        }

        if (confirm(`Are you sure you want to delete the scenario "${scenarioName}"?`)) {
            const scenarios = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
            delete scenarios[scenarioName];
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(scenarios));
            populateScenarioSelect();
            // Clear the input name field
            document.getElementById('scenarioNameInput').value = ''; 
            document.getElementById('statusMessage').textContent = `Scenario "${scenarioName}" deleted.`;
            
            // Optional: reset to default data or clear the form after delete
            // resetToDefaultData(); 
        }
    };
    
    /**
     * Populates the scenario select dropdown.
     * @param {string} [selectName] - The name of the scenario to select by default.
     */
    function populateScenarioSelect(selectName) {
        const select = document.getElementById('scenarioSelect');
        select.innerHTML = '<option value="">-- None loaded --</option>';
        const scenarios = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
        
        let foundSelected = false;

        Object.keys(scenarios).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
            
            if (name === selectName) {
                select.value = name;
                foundSelected = true;
            }
        });
        
        if (selectName && !foundSelected) {
             select.value = ""; // Reset if the selected scenario was deleted
        }
    }
    
    /**
     * Loads the saved data back into all the HTML input elements.
     * @param {object} loadedData - The data object loaded from storage.
     */
    function loadDataToInputs(loadedData) {
        // Text Inputs
        document.getElementById('inputPropertyAddress').value = loadedData.propertyAddress;
        document.getElementById('inputMLSNumber').value = loadedData.mlsNumber;

        // Number Inputs
        document.getElementById('inputPurchasePrice').value = loadedData.purchasePrice;
        document.getElementById('inputDownPaymentPct').value = loadedData.downPaymentPct;
        document.getElementById('inputClosingCosts').value = loadedData.closingCosts;
        document.getElementById('inputCapEx').value = loadedData.initialCapEx;
        document.getElementById('inputInterestRate').value = loadedData.interestRate;
        document.getElementById('inputLoanTerm').value = loadedData.loanTerm;
        document.getElementById('inputVacancyRate').value = loadedData.vacancyRate;
        document.getElementById('inputPropertyTax').value = loadedData.propertyTax;
        document.getElementById('inputInsurance').value = loadedData.insurance;
        document.getElementById('inputManagementFeePct').value = loadedData.managementFeePct;
        document.getElementById('inputUtilities').value = loadedData.utilities;
        document.getElementById('inputRepairs').value = loadedData.repairs;
        document.getElementById('inputReserves').value = loadedData.reserves;
        document.getElementById('inputOtherOpEx').value = loadedData.otherOpEx;
        document.getElementById('inputRentGrowth').value = loadedData.rentGrowth;
        document.getElementById('inputExpenseGrowth').value = loadedData.expenseGrowth;
        document.getElementById('inputExitYear').value = loadedData.exitYear;
        document.getElementById('inputExitCapRate').value = loadedData.exitCapRate;
        document.getElementById('inputSaleCostsPct').value = loadedData.saleCostsPct;

        // Unit Mix is updated via renderInputTab() which happens inside updateAndCalculate()
    }

    /**
     * Saves the current data to a default (unsaved) key in local storage.
     * This allows the user's current session state to persist between page reloads.
     */
    function saveCurrentDataToLocal() {
        try {
            localStorage.setItem('sarrow-current-session', JSON.stringify(data));
        } catch (e) {
            console.warn("Could not save session data to local storage.", e);
        }
    }

    /**
     * Loads data from the last session if available, otherwise initializes default data.
     */
    function initializeData() {
        try {
            const savedData = localStorage.getItem('sarrow-current-session');
            if (savedData) {
                // Merge saved data with defaults to ensure all keys exist for calculations
                const loadedData = JSON.parse(savedData);
                data = { ...data, ...loadedData };
            }
        } catch (e) {
            console.error("Error loading session data, using defaults.", e);
        }
    }


    /**
     * Initial function called on page load.
     */
    window.initializeApp = function() {
        initializeData();
        populateScenarioSelect();
        // Load data from the data object into the input fields
        loadDataToInputs(data); 
        // Run initial calculation and rendering
        updateAndCalculate(); 
        // Default to the assumptions tab
        showTab('assumptions'); 
    };
    
</script>
</body>
</html>
