<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud-Backed Multifamily Pro Forma</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding: 20px;
        }
        .report-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .input-group, .summary-box {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .header-section {
            background-color: #BB2326;
            color: white;
            padding: 20px;
        }
        .input-cell {
            color: #1e40af;
            font-weight: 600;
            text-align: right;
        }
        .calc-cell {
            color: #4b5563;
            font-weight: 500;
        }
        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .positive-return {
            color: #059669;
        }
        .negative-value {
            color: #dc2626;
            font-weight: 600;
        }
        .table-header {
            background-color: #f3f4f6;
            font-weight: 600;
            text-align: left;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom-color: #1e40af;
            color: #1e40af;
        }
        .data-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            font-weight: 600;
            color: #1e40af;
            -moz-appearance: textfield;
        }
        .data-input-text {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: left;
            font-weight: 500;
            color: #1f2937;
        }
        .data-input::-webkit-outer-spin-button,
        .data-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        @media print {
            body { background-color: white; padding: 0; }
            .report-container { box-shadow: none; border-radius: 0; max-width: 100%; }
            .nav-tabs, .print-button-container, .input-form-control, .add-unit-button, #statusMessage {
                display: none !important;
            }
            .tab-content { display: block !important; padding: 0 !important; margin: 0; width: 100%; }
            #projections, #assumptions { page-break-before: always; }
        }
    </style>
</head>
<body onload="initializeApp()">

<div class="report-container">
    <!-- Header Section -->
    <header class="header-section flex flex-col md:flex-row justify-between items-center bg-[#0A1A44] text-white border-b-4 border-[#CFAF66] py-4 px-6">

        <!-- LEFT: Brand block -->
        <div class="text-center md:text-left leading-tight mb-4 md:mb-0">
            <p class="text-lg md:text-xl font-semibold tracking-wide uppercase">
                Jonathan Sarrow
            </p>
            <p class="text-sm md:text-base">
                Realtor¬Æ | DRE# 02151231
            </p>
            <p class="text-sm md:text-base">
                818-469-5309 ¬∑ jonathan@sheishoperealty.com
            </p>
        </div>

        <!-- RIGHT: Title + Status -->
        <div class="text-center md:text-right leading-tight mb-4 md:mb-0 md:flex-1 md:pr-6">
            <h1 class="text-xl md:text-2xl font-bold whitespace-nowrap">
                Multifamily Investment Pro Forma
            </h1>

            <p id="statusMessage" class="mt-1 text-xs font-medium text-yellow-300 transition duration-300">
                Enter fields with desired values to save a version
            </p>
        </div>

        <!-- BUTTON -->
        <div class="mt-4 md:mt-0 flex items-center">
            <button onclick="window.print()"
                    class="text-black font-semibold py-2 px-4 rounded-lg shadow-md transition
                           bg-[#CFAF66] hover:bg-[#B08E3C] border border-[#9C7A2F]">
                Print/Save PDF
            </button>
        </div>
    </header>

    <!-- Tab Navigation (Hidden during print) -->
    <div class="nav-tabs border-b border-gray-200 bg-gray-50">
        <button class="tab-button" onclick="showTab('assumptions')">1. Inputs &amp; Assumptions</button>
        <button class="tab-button" onclick="showTab('summary')">2. Year 1 Summary</button>
        <button class="tab-button" onclick="showTab('projections')">3. Five-Year Projections</button>
    </div>

    <!-- Tab Content -->
    <main class="p-5">

        <!-- Tab 2 (now): Year 1 Summary -->
        <div id="summary" class="tab-content hidden">
            <h1 class="text-xl font-bold mb-4 print:hidden">2. Year 1 Summary &amp; Key Metrics</h1>
            <h1 class="text-xl font-bold mb-4 hidden print:block">2. Year 1 Summary &amp; Key Metrics</h1>

            <!-- Property Header Card -->
            <div class="bg-blue-600 text-white p-4 rounded-lg shadow-xl mb-6">
                <h2 id="summaryPropertyAddress" class="text-2xl font-extrabold truncate"></h2>
                <p class="text-blue-200 text-sm mt-1">
                    MLS #:
                    <span id="summaryMLSNumber" class="font-semibold">N/A</span>
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Primary Summary Blocks -->
                <div class="lg:col-span-2 space-y-4">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-4">
                        Initial Investment &amp; Year 1 Cash Flow
                    </h2>

                    <!-- Operating Summary -->
                    <div class="input-group">
                        <h3 class="text-lg font-bold mb-3">Operating Summary</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <p class="font-medium">Gross Potential Income (GPI):</p>
                            <p class="text-right calc-cell" id="calcGPI"></p>

                            <p class="font-medium">
                                Vacancy Loss (<span id="vacancyRateDisplay"></span>%):
                            </p>
                            <p class="text-right negative-value" id="calcVacancy"></p>

                            <p class="font-bold border-t pt-2">Effective Gross Income (EGI):</p>
                            <p class="text-right font-bold border-t pt-2 text-lg text-green-700" id="calcEGI"></p>
                        </div>
                    </div>

                    <!-- Expenses and Debt Service -->
                    <div class="input-group">
                        <h3 class="text-lg font-bold mb-3">Expenses and Debt Service</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <p class="font-medium">Total Operating Expenses (OpEx):</p>
                            <p class="text-right negative-value" id="calcOpEx"></p>

                            <p class="font-bold border-t pt-2">Net Operating Income (NOI):</p>
                            <p class="text-right font-bold border-t pt-2 text-lg text-green-700" id="calcNOI"></p>

                            <p class="font-medium mt-4 border-t pt-2">Annual Debt Service (P&amp;I):</p>
                            <p class="text-right negative-value mt-4 border-t pt-2" id="calcADS"></p>

                            <p class="font-bold pt-2">Annual Cash Flow:</p>
                            <p class="text-right font-bold pt-2 text-xl" id="calcCashFlow"></p>
                        </div>
                    </div>

                    <!-- Unit Mix Snapshot (OUTPUT ONLY) -->
                    <div class="input-group">
                        <h3 class="text-lg font-bold mb-3">Unit Mix &amp; Income (Snapshot)</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="table-header">
                            <tr>
                                <th class="p-2">Unit Type</th>
                                <th class="p-2 text-center">Beds</th>
                                <th class="p-2 text-center">Baths</th>
                                <th class="p-2 text-right"># Units</th>
                                <th class="p-2 text-right">Monthly Rent ($)</th>
                                <th class="p-2 text-right">Annual Rent ($)</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200" id="unitMixSummaryBody">
                            <!-- Filled by JS -->
                            </tbody>
                            <tfoot>
                            <tr class="font-bold bg-blue-50/50">
                                <td colspan="5" class="p-2 text-right">Gross Annual Rent (GPI)</td>
                                <td class="p-2 text-right text-lg text-blue-700" id="gpiOutput"></td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- KPI and Investment Summary -->
                <div class="lg:col-span-1">
                    <div class="summary-box bg-blue-50 h-full">
                        <h2 class="text-2xl font-semibold text-blue-800 border-b border-blue-200 pb-2 mb-4">
                            Investment Summary (Year 1)
                        </h2>
                        <div class="space-y-5">
                            <p class="font-medium">Purchase Price:</p>
                            <p class="text-right kpi-value text-blue-900" id="summaryPurchasePrice"></p>

                            <p class="font-medium">Total Initial Cash Invested:</p>
                            <p class="text-right kpi-value text-blue-900" id="summaryCashInvested"></p>

                            <hr class="border-blue-200"/>

                            <h3 class="text-xl font-bold text-gray-700 pt-2">Key Performance Indicators</h3>

                            <p class="font-medium text-lg">
                                Cash-on-Cash Return
                                <span class="text-xs text-gray-500 ml-1"
                                      title="Year 1 cash flow divided by total cash invested">
                                    (Year 1 CF √∑ Cash In)
                                </span>
                            </p>
                            <p class="text-right kpi-value positive-return" id="summaryCoC"></p>

                            <p class="font-medium text-lg">
                                Capitalization Rate (Cap Rate)
                                <span class="text-xs text-gray-500 ml-1"
                                      title="NOI divided by purchase price">
                                    (NOI √∑ Price)
                                </span>
                            </p>
                            <p class="text-right kpi-value" id="summaryCapRate"></p>

                            <p class="font-medium text-lg">
                                Debt Service Coverage Ratio (DSCR)
                                <span class="text-xs text-gray-500 ml-1"
                                      title="NOI divided by annual debt service">
                                    (NOI √∑ ADS)
                                </span>
                            </p>
                            <p class="text-right kpi-value" id="summaryDSCR"></p>
                            <p class="text-xs text-right" id="dscrInterpretation"></p>

                            <hr class="border-blue-200"/>

                            <p class="font-medium text-lg pt-2">Projected Annual Cash Flow:</p>
                            <p class="text-right kpi-value" id="summaryCashFlow"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: 5-Year Projections -->
        <div id="projections" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-4">
                3. 5-Year Projections (Includes Growth)
            </h2>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="table-header sticky top-0 bg-white shadow-sm">
                    <tr>
                        <th class="p-3">Metric</th>
                        <th class="p-3 text-center">Year 1 (Initial)</th>
                        <th class="p-3 text-center">Year 2</th>
                        <th class="p-3 text-center">Year 3</th>
                        <th class="p-3 text-center">Year 4</th>
                        <th class="p-3 text-center">Year 5 (Sale)</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="projectionTableBody">
                    <!-- Data populated by JS -->
                    </tbody>
                </table>
            </div>

            <div class="mt-8 summary-box bg-red-50 border-red-200">
                <h3 class="text-xl font-bold text-red-700 mb-3">Exit Analysis &amp; Total Return</h3>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <p class="font-medium">Exit Cap Rate:</p>
                    <p class="text-right calc-cell" id="exitCapRate"></p>

                    <p class="font-medium">Projected Sale Price:</p>
                    <p class="text-right text-blue-700 font-bold" id="projectedSalePrice"></p>

                    <p class="font-medium">Debt Remaining (Year 5):</p>
                    <p class="text-right negative-value font-bold" id="remainingDebt"></p>

                    <p class="font-medium">Sale Proceeds After Debt/Costs:</p>
                    <p class="text-right positive-return text-2xl font-extrabold" id="saleProceeds"></p>
                </div>

                <hr class="my-4 border-red-300"/>

                <div class="grid grid-cols-2 gap-4">
                    <p class="font-medium text-lg">Equity Multiple:</p>
                    <p class="text-right kpi-value" id="equityMultiple"></p>

                    <p class="font-medium text-lg">Internal Rate of Return (IRR):</p>
                    <p class="text-right kpi-value" id="projectIRR"></p>
                </div>
            </div>
        </div>

        <!-- Tab 1: Inputs and Assumptions (NOW INTERACTIVE) -->
        <div id="assumptions" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-2">
                1. Core Inputs &amp; Financial Assumptions
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Start here: set your property, loan, unit mix, and operating assumptions. The other tabs will update
                automatically.
            </p>

            <!-- Property Details Section -->
            <div class="input-group bg-indigo-50">
                <h3 class="text-lg font-bold mb-3 text-indigo-700">Property Identification</h3>
                <div class="space-y-2">
                    <label class="block">Property Address:
                        <input type="text" id="inputPropertyAddress" class="data-input-text"
                               value="123 Main St, Anytown, USA" oninput="updateAndCalculate()">
                    </label>
                    <label class="block">MLS Number:
                        <input type="text" id="inputMLSNumber" class="data-input-text"
                               value="MLS-1234567" oninput="updateAndCalculate()">
                    </label>
                </div>
            </div>

            <!-- Scenario Management -->
            <div class="input-group bg-green-50 mt-4">
                <h3 class="text-lg font-bold mb-3 text-green-700">Scenario Management</h3>
                <p class="text-xs text-gray-600 mb-2">
                    Save different versions of this pro forma (e.g., ‚ÄúSeller‚Äôs Ask‚Äù, ‚ÄúMy Offer‚Äù, ‚ÄúValue-Add Plan‚Äù)
                    and reload them later on this device.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium mb-1">Scenario Name</label>
                        <input
                                type="text"
                                id="scenarioNameInput"
                                class="data-input-text"
                                placeholder="e.g., 8-unit ‚Äì My Offer"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Saved Scenarios</label>
                        <select
                                id="scenarioSelect"
                                class="data-input-text"
                                onchange="window.handleScenarioSelectChange()"
                        >
                            <option value="">-- None loaded --</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <button
                                type="button"
                                onclick="window.saveScenarioFromUI()"
                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150"
                        >
                            üíæ Save Scenario
                        </button>
                        <button
                                type="button"
                                onclick="window.deleteSelectedScenario()"
                                class="bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150"
                        >
                            üóë Delete
                        </button>
                    </div>
                </div>
            </div>

            <!-- Unit Mix (INPUTS) -->
            <div class="input-group bg-blue-50 mt-4">
                <h3 class="text-lg font-bold mb-3 text-blue-800">Unit Mix (Inputs)</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                    <tr>
                        <th class="p-2">Unit Type</th>
                        <th class="p-2">Beds</th>
                        <th class="p-2">Baths</th>
                        <th class="p-2 text-right"># Units</th>
                        <th class="p-2 text-right">Monthly Rent ($)</th>
                        <th class="p-2 text-right">Annual Rent ($)</th>
                        <th class="p-2 text-center input-form-control">Actions</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="unitMixBody">
                    <!-- Rows populated by renderUnitMixInput() -->
                    </tbody>
                    <tfoot>
                    <tr class="font-bold bg-blue-50/50">
                        <td colspan="5" class="p-2 text-right">Gross Annual Rent (GPI)</td>
                        <td class="p-2 text-right text-lg text-blue-700" id="gpiInputTabOutput"></td>
                        <td class="p-2 input-form-control text-center">
                            <button onclick="addUnit()"
                                    class="add-unit-button bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded-md transition duration-150">
                                + Add Unit
                            </button>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                <!-- Acquisition -->
                <div class="input-group bg-gray-50">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">Acquisition Details</h3>
                    <div class="space-y-2">
                        <label class="block">Purchase Price ($):
                            <input type="number" id="inputPurchasePrice" class="data-input" value="1200000"
                                   oninput="updateAndCalculate()" min="1">
                        </label>
                        <label class="block">Down Payment (%):
                            <input type="number" id="inputDownPaymentPct" class="data-input" value="20"
                                   oninput="updateAndCalculate()" min="1" max="100">
                        </label>
                        <label class="block">Closing Costs ($):
                            <input type="number" id="inputClosingCosts" class="data-input" value="20000"
                                   oninput="updateAndCalculate()" min="0">
                        </label>
                        <label class="block">Initial CapEx/Repairs ($):
                            <input type="number" id="inputCapEx" class="data-input" value="10000"
                                   oninput="updateAndCalculate()" min="0">
                        </label>
                        <hr class="my-2 border-gray-300"/>
                        <p class="font-bold">
                            Total Cash Invested:
                            <span class="float-right text-blue-700" id="inputCashInvested"></span>
                        </p>
                    </div>
                </div>

                <!-- Loan Details -->
                <div class="input-group bg-gray-50">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">Loan Parameters</h3>
                    <div class="space-y-2">
                        <p>
                            Loan Amount:
                            <span class="float-right calc-cell" id="inputLoanAmount"></span>
                        </p>
                        <label class="block">Interest Rate (Annual %):
                            <input type="number" id="inputInterestRate" class="data-input" value="6.5"
                                   oninput="updateAndCalculate()" min="0.1" step="0.1">
                        </label>
                        <label class="block">Loan Term (Years):
                            <input type="number" id="inputLoanTerm" class="data-input" value="30"
                                   oninput="updateAndCalculate()" min="5" step="1">
                        </label>
                        <p>
                            Monthly Payment (P&amp;I):
                            <span class="float-right calc-cell font-bold text-red-600" id="inputMonthlyPmt"></span>
                        </p>
                        <p>
                            Annual Debt Service (ADS):
                            <span class="float-right calc-cell" id="inputADS"></span>
                        </p>
                        <hr class="my-2 border-gray-300"/>
                        <p class="font-bold">
                            Total Payments (Loan Term):
                            <span class="float-right text-red-600" id="inputTotalPayments"></span>
                        </p>
                    </div>
                </div>

                <!-- Growth & Sale Assumptions -->
                <div class="input-group bg-yellow-50">
                    <h3 class="text-lg font-bold mb-3 text-red-700">Growth &amp; Exit Assumptions</h3>
                    <div class="space-y-2">
                        <label class="block">Holding Period (Years):
                            <input type="number" id="inputHoldPeriod" class="data-input" value="5"
                                   oninput="updateAndCalculate()" min="1" max="30" step="1">
                        </label>
                        <label class="block">Vacancy Rate (%):
                            <input type="number" id="inputVacancyRate" class="data-input" value="3"
                                   oninput="updateAndCalculate()" min="0" step="0.5">
                        </label>
                        <label class="block">Rent Increase (Annual %):
                            <input type="number" id="inputRentIncrease" class="data-input" value="2"
                                   oninput="updateAndCalculate()" min="0" step="0.1">
                        </label>
                        <label class="block">Expense Inflation (Annual %):
                            <input type="number" id="inputExpenseIncrease" class="data-input" value="3"
                                   oninput="updateAndCalculate()" min="0" step="0.1">
                        </label>
                        <label class="block">Exit Cap Rate (%):
                            <input type="number" id="inputExitCapRate" class="data-input" value="6.5"
                                   oninput="updateAndCalculate()" min="0.1" step="0.1">
                        </label>
                        <label class="block">Selling Costs (%):
                            <input type="number" id="inputSellingCosts" class="data-input" value="5"
                                   oninput="updateAndCalculate()" min="0" step="0.1">
                        </label>
                    </div>
                </div>
            </div>

            <div class="input-group mt-6">
                <h3 class="text-lg font-bold mb-3 text-gray-700">Operating Expense Details (Year 1)</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <label class="block">Property Tax Rate (% of Price):
                        <input type="number" id="inputTaxRate" class="data-input" value="1.25"
                               oninput="updateAndCalculate()" min="0" step="0.01">
                        <p class="text-xs text-right text-gray-500 mt-1">
                            Year 1 Tax:
                            <span class="text-blue-600 font-semibold" id="outputAnnualTaxes"></span>
                        </p>
                    </label>
                    <label class="block">Annual Insurance ($):
                        <input type="number" id="inputInsurance" class="data-input" value="3200"
                               oninput="updateAndCalculate()" min="0">
                    </label>
                    <label class="block">Management Fee (% of EGI):
                        <input type="number" id="inputMgmtFeePct" class="data-input" value="3"
                               oninput="updateAndCalculate()" min="0" max="100" step="0.1">
                        <p class="text-xs text-right text-gray-500 mt-1">
                            Year 1 Fee:
                            <span class="text-blue-600 font-semibold" id="outputMgmtFee"></span>
                        </p>
                    </label>
                    <label class="block">Maintenance/Reserves ($):
                        <input type="number" id="inputMaintenance" class="data-input" value="5000"
                               oninput="updateAndCalculate()" min="0">
                    </label>
                </div>
            </div>
        </div>

    </main>
</div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBAL FIREBASE/STATE VARIABLES ---
    let db;
    let auth;
    let userId = null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Path: /artifacts/{appId}/public/data/proformas/main_model (Public/Shared Data)
    const PROFORMA_DOC_ID = 'main_model';

    // Initialize currentData to a safe, default structure
    let currentData = null;
    let globalResults = {};
    let unitIdCounter = 0;
    let isAuthReady = false;

    // --- LOCAL STORAGE KEYS ---
    const LOCAL_STORAGE_KEY_CURRENT = 'mfProforma_current';
    const LOCAL_STORAGE_KEY_SCENARIOS = 'mfProforma_scenarios';

    // --- DEFAULTS ---
    const defaultState = {
        // PROPERTY IDENTIFICATION FIELDS
        propertyAddress: "123 Main St, Anytown, USA",
        mlsNumber: "MLS-1234567",

        purchasePrice: 1200000, downPaymentPct: 0.20, closingCosts: 20000, initialCapEx: 10000,
        interestRate: 0.065, loanTermYears: 30, taxRatePct: 0.0125, annualInsurance: 3200,
        mgmtFeePct: 0.03, annualMaintenance: 5000, annualOtherExpense: 0,
        holdPeriodYears: 5, vacancyRate: 0.03, rentIncreasePct: 0.02,
        expenseIncreasePct: 0.03, exitCapRate: 0.065, sellingCostsPct: 0.05,
        // Compressed into types with unitCount
        units: [
            { id: 1, unitType: "2x2", beds: 2, baths: 2, rent: 1400, unitCount: 2 },
            { id: 2, unitType: "1x1", beds: 1, baths: 1, rent: 1200, unitCount: 2 }
        ]
    };

    // --- UTILITIES ---

    const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
    const formatterDec = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 });
    const percentFormatter = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2 });

    function format(value, isPercent = false, allowDecimals = true) {
        if (value === null || isNaN(value) || !isFinite(value)) return 'N/A';
        if (isPercent) return percentFormatter.format(value);
        if (allowDecimals) return formatterDec.format(value);
        return formatter.format(value);
    }

    let saveTimeout;
    /** Debounces the save function to prevent excessive database writes */
    function saveDebounced() {
        if (saveTimeout) {
            clearTimeout(saveTimeout);
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = 'Saving...';
            statusEl.classList.remove('text-green-400', 'text-red-400');
            statusEl.classList.add('text-yellow-300');
        }
        saveTimeout = setTimeout(() => {
            if (!currentData || !currentData.units || currentData.units.length === 0) {
                console.warn("[Save Debounced] Data structure is null or units are empty. Skipping save.");
                setStatus('Data incomplete. Skipping save.', 'info');
                return;
            }
            saveProForma();
        }, 800);
    }

    function setStatus(message, type = 'info') {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = message;
        statusEl.className = 'mt-2 text-xs font-medium transition duration-300';
        if (type === 'success') statusEl.classList.add('text-green-400');
        else if (type === 'error') statusEl.classList.add('text-red-400');
        else statusEl.classList.add('text-yellow-300');
    }

    // --- LOCAL STORAGE HELPERS (CURRENT SNAPSHOT) ---

    function saveCurrentToLocal() {
        try {
            if (!currentData) return;
            localStorage.setItem(LOCAL_STORAGE_KEY_CURRENT, JSON.stringify(currentData));
        } catch (e) {
            console.warn('[LocalStorage] Unable to save current snapshot:', e);
        }
    }

    function loadCurrentFromLocal() {
        try {
            const raw = localStorage.getItem(LOCAL_STORAGE_KEY_CURRENT);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object') return null;
            return parsed;
        } catch (e) {
            console.warn('[LocalStorage] Unable to load current snapshot:', e);
            return null;
        }
    }

    // --- LOCAL STORAGE HELPERS (SCENARIOS LIST) ---

    function loadScenarioList() {
        try {
            const raw = localStorage.getItem(LOCAL_STORAGE_KEY_SCENARIOS);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.warn('[LocalStorage] Unable to load scenarios:', e);
            return [];
        }
    }

    function saveScenarioList(list) {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY_SCENARIOS, JSON.stringify(list || []));
        } catch (e) {
            console.warn('[LocalStorage] Unable to save scenarios:', e);
        }
    }

    function refreshScenarioDropdown() {
        const select = document.getElementById('scenarioSelect');
        if (!select) return;

        const scenarios = loadScenarioList();
        const current = select.value;

        select.innerHTML = '<option value="">-- None loaded --</option>';

        scenarios.forEach((s) => {
            const opt = document.createElement('option');
            opt.value = String(s.id);
            opt.textContent =
                `${s.name || 'Untitled'} (${new Date(s.timestamp).toLocaleString()})`;
            select.appendChild(opt);
        });

        if (current && scenarios.some((s) => String(s.id) === current)) {
            select.value = current;
        }
    }

    // --- SCENARIO SAVE / LOAD / DELETE ---

    window.saveScenarioFromUI = function () {
        if (!currentData) return;
        const nameInput = document.getElementById('scenarioNameInput');
        let name = (nameInput?.value || '').trim();

        if (!name) {
            name = currentData.propertyAddress || 'Untitled Scenario';
        }

        const scenarios = loadScenarioList();
        const id = Date.now();

        scenarios.push({
            id,
            name,
            timestamp: Date.now(),
            data: currentData
        });

        saveScenarioList(scenarios);
        refreshScenarioDropdown();

        const select = document.getElementById('scenarioSelect');
        if (select) select.value = String(id);

        setStatus(`Scenario "${name}" saved locally.`, 'success');
    };

    window.handleScenarioSelectChange = function () {
        const select = document.getElementById('scenarioSelect');
        const id = select?.value;
        if (!id) return;

        const scenarios = loadScenarioList();
        const scenario = scenarios.find((s) => String(s.id) === id);
        if (!scenario) return;

        currentData = scenario.data;

        applyDataToDOMFromLoadedData(currentData);
        renderUnitMixInput();
        runAllCalculations();
        renderAll();
        saveCurrentToLocal();

        const nameInput = document.getElementById('scenarioNameInput');
        if (nameInput) nameInput.value = scenario.name || '';
        setStatus(`Scenario "${scenario.name}" loaded.`, 'info');
    };

    window.deleteSelectedScenario = function () {
        const select = document.getElementById('scenarioSelect');
        const id = select?.value;
        if (!id) return;

        let scenarios = loadScenarioList();
        const scenario = scenarios.find((s) => String(s.id) === id);
        scenarios = scenarios.filter((s) => String(s.id) !== String(id));

        saveScenarioList(scenarios);
        refreshScenarioDropdown();

        select.value = '';
        setStatus(`Scenario "${scenario?.name || ''}" deleted.`, 'info');
    };

    // --- FIREBASE OPERATIONS ---

    function getProFormaDocRef() {
        return doc(db, 'artifacts', appId, 'public', 'data', 'proformas', PROFORMA_DOC_ID);
    }

    async function saveProForma() {
        if (!db || !isAuthReady || !currentData || !currentData.units || currentData.units.length === 0) {
            console.warn("[Firebase] Firestore not ready, not authenticated, or data invalid. Skipping save.");
            return;
        }

        try {
            await setDoc(getProFormaDocRef(), currentData, { merge: true });
            setStatus('Saved to Cloud', 'success');
        } catch (e) {
            console.error("[Firebase] Error saving document: ", e);
            setStatus('Error Saving Data! Check console.', 'error');
        }
    }

    function loadProForma() {
        if (!db || !isAuthReady) {
            console.log("[Firebase] Load function called, but not ready. Waiting for auth.");
            return;
        }

        const docRef = getProFormaDocRef();
        const docPath = docRef.path;
        setStatus('Connecting to Cloud...');
        console.log(`[Firebase Load Status] Attempting to load document from path: ${docPath}`);

        onSnapshot(docRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const loadedData = docSnapshot.data();
                console.log("[Firebase Load Status] Document found! Data:", loadedData);

                if (!loadedData || !loadedData.units || typeof loadedData.purchasePrice !== 'number') {
                    console.error("[Firebase Load Status] Loaded data is missing key fields or is corrupt. Falling back to defaults.");
                    currentData = JSON.parse(JSON.stringify(defaultState));
                    setStatus('Loaded, but data was corrupt. Using defaults.', 'error');
                } else {
                    currentData = loadedData;
                    setStatus('Loaded from Cloud - Realtime Sync Active', 'success');
                }

                const maxUnitId = currentData.units.reduce((max, unit) => Math.max(max, unit.id), 0);
                unitIdCounter = maxUnitId + 1;

                applyDataToDOMFromLoadedData(currentData);
                renderUnitMixInput();
                runAllCalculations();
                renderAll();

            } else {
                console.log("[Firebase Load Status] Document does not exist at path. Initializing with defaults.");
                currentData = JSON.parse(JSON.stringify(defaultState));
                unitIdCounter = defaultState.units.length + 1;
                applyDataToDOMFromLoadedData(currentData);
                renderUnitMixInput();
                updateAndCalculate();
                setStatus('Initialized with default data. Saving...', 'info');
            }
        }, (error) => {
            console.error("[Firebase Load Status] ERROR listening to document: ", error);
            setStatus('Error loading data! Using defaults.', 'error');
            currentData = JSON.parse(JSON.stringify(defaultState));
            unitIdCounter = defaultState.units.length + 1;
            applyDataToDOMFromLoadedData(currentData);
            renderUnitMixInput();
            runAllCalculations();
            renderAll();
        });
    }

    // --- INPUT READING AND UNIT MANAGEMENT ---

    function readInputs() {
        if (!currentData) {
            console.warn("[Read Inputs] currentData is null. Initializing with default state.");
            currentData = JSON.parse(JSON.stringify(defaultState));
        }

        const getNum = (id, isPercent = false) => {
            const el = document.getElementById(id);
            if (!el) return 0;
            const val = parseFloat(el.value);
            return isPercent ? (val || 0) / 100 : (val || 0);
        };
        const getString = (id) => {
            const el = document.getElementById(id);
            return el ? el.value.trim() : '';
        };

        const newData = {
            propertyAddress: getString('inputPropertyAddress'),
            mlsNumber: getString('inputMLSNumber'),

            purchasePrice: getNum('inputPurchasePrice'),
            downPaymentPct: getNum('inputDownPaymentPct', true),
            closingCosts: getNum('inputClosingCosts'),
            initialCapEx: getNum('inputCapEx'),

            interestRate: getNum('inputInterestRate', true),
            loanTermYears: getNum('inputLoanTerm'),

            holdPeriodYears: getNum('inputHoldPeriod'),
            vacancyRate: getNum('inputVacancyRate', true),
            rentIncreasePct: getNum('inputRentIncrease', true),
            expenseIncreasePct: getNum('inputExpenseIncrease', true),
            exitCapRate: getNum('inputExitCapRate', true),
            sellingCostsPct: getNum('inputSellingCosts', true),

            taxRatePct: getNum('inputTaxRate', true),
            annualInsurance: getNum('inputInsurance'),
            mgmtFeePct: getNum('inputMgmtFeePct', true),
            annualMaintenance: getNum('inputMaintenance'),
            annualOtherExpense: 0,
            units: []
        };

        newData.units = Array.from(document.querySelectorAll('#unitMixBody tr')).map(row => {
            const rentInput = row.querySelector('input[data-field="rent"]');
            const bedsInput = row.querySelector('input[data-field="beds"]');
            const bathsInput = row.querySelector('input[data-field="baths"]');
            const unitTypeInput = row.querySelector('input[data-field="unitType"]');
            const unitCountInput = row.querySelector('input[data-field="unitCount"]');
            const id = parseInt(row.dataset.unitId);

            const unitCount = parseInt(unitCountInput?.value || 1) || 1;

            return {
                id: id,
                unitType: unitTypeInput?.value.trim() || '',
                beds: parseInt(bedsInput?.value || 0) || 0,
                baths: parseFloat(bathsInput?.value || 0) || 0,
                rent: parseFloat(rentInput?.value || 0) || 0,
                unitCount: unitCount
            };
        });

        if (newData.holdPeriodYears > newData.loanTermYears) {
            newData.holdPeriodYears = newData.loanTermYears;
        }
        if (newData.purchasePrice < 0) newData.purchasePrice = 0;

        currentData = newData;
        return currentData;
    }

    function renderUnitMixInput() {
        const unitMixBody = document.getElementById('unitMixBody');
        if (!unitMixBody || !currentData || !currentData.units) return;

        unitMixBody.innerHTML = currentData.units.map(unit => {
            const count = typeof unit.unitCount === 'number' && unit.unitCount > 0 ? unit.unitCount : 1;
            const typeLabel = unit.unitType || '';
            const annual = unit.rent * 12 * count;
            return `
            <tr data-unit-id="${unit.id}">
                <td class="p-2 input-form-control">
                    <input type="text" data-field="unitType" class="data-input-text" value="${typeLabel}" placeholder="e.g., 2x2" oninput="updateAndCalculate()">
                </td>
                <td class="p-2 input-form-control">
                    <input type="number" data-field="beds" class="data-input w-12 text-center" value="${unit.beds}" oninput="updateAndCalculate()" min="0" step="1">
                </td>
                <td class="p-2 input-form-control">
                    <input type="number" data-field="baths" class="data-input w-12 text-center" value="${unit.baths}" oninput="updateAndCalculate()" min="0" step="0.5">
                </td>
                <td class="p-2 input-form-control">
                    <input type="number" data-field="unitCount" class="data-input w-16 text-center" value="${count}" oninput="updateAndCalculate()" min="1" step="1">
                </td>
                <td class="p-2 input-form-control">
                    <input type="number" data-field="rent" class="data-input" value="${unit.rent}" oninput="updateAndCalculate()" min="0">
                </td>
                <td class="p-2 text-right calc-cell unit-annual-rent">${format(annual, false, false)}</td>
                <td class="p-2 text-center input-form-control">
                    <button onclick="removeUnit(${unit.id})" class="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-md transition duration-150">
                        X
                    </button>
                </td>
            </tr>
        `}).join('');
    }

    window.addUnit = function () {
        if (!currentData) {
            console.error("Cannot add unit: currentData is null.");
            return;
        }
        const newUnitId = unitIdCounter++;
        currentData.units.push({
            id: newUnitId,
            unitType: "",
            beds: 1,
            baths: 1,
            rent: 1200,
            unitCount: 1
        });
        renderUnitMixInput();
        updateAndCalculate();
    };

    window.removeUnit = function (id) {
        if (!currentData || !currentData.units) return;
        currentData.units = currentData.units.filter(unit => unit.id !== id);
        renderUnitMixInput();
        updateAndCalculate();
    };

    function applyDataToDOMFromLoadedData(data) {
        if (!data) return;

        const setInputValue = (id, value, isPercent = false) => {
            const el = document.getElementById(id);
            if (el && typeof value === 'number' && !isNaN(value)) {
                el.value = isPercent ? (value * 100).toFixed(2) : value;
            } else if (el) {
                const defaultKey = id.replace('input', '');
                let defaultValue = defaultState[defaultKey];
                if (typeof defaultValue === 'number' && defaultValue >= 0 && defaultValue <= 1) {
                    defaultValue = defaultValue * 100;
                } else if (typeof defaultValue !== 'number') {
                    defaultValue = 0;
                }
                el.value = defaultValue;
            }
        };
        const setTextInputValue = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.value = value || '';
        };

        setTextInputValue('inputPropertyAddress', data.propertyAddress);
        setTextInputValue('inputMLSNumber', data.mlsNumber);

        setInputValue('inputPurchasePrice', data.purchasePrice);
        setInputValue('inputDownPaymentPct', data.downPaymentPct, true);
        setInputValue('inputClosingCosts', data.closingCosts);
        setInputValue('inputCapEx', data.initialCapEx);

        setInputValue('inputInterestRate', data.interestRate, true);
        setInputValue('inputLoanTerm', data.loanTermYears);

        setInputValue('inputHoldPeriod', data.holdPeriodYears);
        setInputValue('inputVacancyRate', data.vacancyRate, true);
        setInputValue('inputRentIncrease', data.rentIncreasePct, true);
        setInputValue('inputExpenseIncrease', data.expenseIncreasePct, true);
        setInputValue('inputExitCapRate', data.exitCapRate, true);
        setInputValue('inputSellingCosts', data.sellingCostsPct, true);

        setInputValue('inputTaxRate', data.taxRatePct, true);
        setInputValue('inputInsurance', data.annualInsurance);
        setInputValue('inputMgmtFeePct', data.mgmtFeePct, true);
        setInputValue('inputMaintenance', data.annualMaintenance);
    }

    // --- FINANCIAL CALCULATIONS ---

    function calculatePmt(rate, nper, pv) {
        if (rate === 0) return -pv / nper;
        const pmt = rate * pv * Math.pow(1 + rate, nper) / (Math.pow(1 + rate, nper) - 1);
        return pmt;
    }

    function calculateRemainingBalance(rate, nper, pmt, fv) {
        if (rate === 0) return -(fv + pmt * nper);
        const pv = (pmt * (1 - Math.pow(1 + rate, -nper)) / rate) - fv / Math.pow(1 + rate, nper);
        return pv;
    }

    function runAllCalculations() {
        const data = currentData;
        if (!data || !data.units || data.units.length === 0 || data.purchasePrice === 0) {
            globalResults = {
                loanAmount: 0, initialCashInvested: 0, annualDebtService: 0,
                gpi: 0, egi: 0, noi: 0, totalOpEx: 0, cashFlowY1: 0,
                remainingDebtY5: 0, projectionData: [], projectedSalePrice: 0,
                netSaleProceeds: 0, equityMultiple: 0, projectIRR: 0,
                managementFeeY1: 0
            };
            return;
        }

        const downPayment = data.purchasePrice * data.downPaymentPct;
        const loanAmount = data.purchasePrice - downPayment;
        const initialCashInvested = downPayment + data.closingCosts + data.initialCapEx;

        const monthlyRate = data.interestRate / 12;
        const totalPayments = data.loanTermYears * 12;

        const monthlyPmtMagnitude = calculatePmt(monthlyRate, totalPayments, loanAmount);
        const annualDebtService = monthlyPmtMagnitude * -12;

        const gpi = data.units.reduce((sum, unit) => {
            const count = typeof unit.unitCount === 'number' && unit.unitCount > 0 ? unit.unitCount : 1;
            return sum + (unit.rent * 12 * count);
        }, 0);
        const vacancyLoss = gpi * data.vacancyRate;
        const egi = gpi - vacancyLoss;

        const annualTaxes = data.purchasePrice * data.taxRatePct;
        const managementFee = egi * data.mgmtFeePct;
        const totalOpEx = annualTaxes + data.annualInsurance + managementFee + data.annualMaintenance + data.annualOtherExpense;

        const noi = egi - totalOpEx;
        const cashFlowY1 = noi + annualDebtService;

        const N_paid = data.holdPeriodYears * 12;
        const N_remaining = data.loanTermYears * 12 - N_paid;

        const remainingDebtY5 = (N_remaining > 0)
            ? calculateRemainingBalance(monthlyRate, N_remaining, monthlyPmtMagnitude, 0)
            : 0;

        const projectionData = [];
        let currentGPI = gpi;

        for (let y = 1; y <= data.holdPeriodYears; y++) {
            if (y > 1) { currentGPI *= (1 + data.rentIncreasePct); }

            const vacancyLoss_y = currentGPI * data.vacancyRate;
            const egi_y = currentGPI - vacancyLoss_y;

            const annualTaxesInflated = data.purchasePrice * data.taxRatePct * Math.pow(1 + data.expenseIncreasePct, y - 1);
            const annualInsuranceInflated = data.annualInsurance * Math.pow(1 + data.expenseIncreasePct, y - 1);
            const maintenanceInflated = (data.annualMaintenance + data.annualOtherExpense) * Math.pow(1 + data.expenseIncreasePct, y - 1);

            const managementFee_y = egi_y * data.mgmtFeePct;
            const totalOpExAdjusted = annualTaxesInflated + annualInsuranceInflated + managementFee_y + maintenanceInflated;

            const noi_y = egi_y - totalOpExAdjusted;
            const cashFlow_y = noi_y + annualDebtService;

            projectionData.push({ year: y, gpi: currentGPI, egi: egi_y, opEx: totalOpExAdjusted, noi: noi_y, cashFlow: cashFlow_y });
        }

        const finalYearData = projectionData[data.holdPeriodYears - 1] || { noi: 0, cashFlow: 0 };
        const noiYear5 = finalYearData.noi;

        const projectedSalePrice = noiYear5 / data.exitCapRate;
        const sellingCosts = projectedSalePrice * data.sellingCostsPct;
        const netSaleProceeds = projectedSalePrice - sellingCosts - remainingDebtY5;

        const irrCashFlows = [-initialCashInvested];
        projectionData.forEach(d => irrCashFlows.push(d.cashFlow));

        if (irrCashFlows.length > 1) {
            irrCashFlows[data.holdPeriodYears] += netSaleProceeds;
        }

        function calculateIRR(cashFlows) {
            const maxIterations = 1000;
            const precision = 0.00001;
            let guess = 0.1;
            if (cashFlows.length === 0 || initialCashInvested === 0) return 0;

            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let derivative = 0;
                for (let t = 0; t < cashFlows.length; t++) {
                    npv += cashFlows[t] / Math.pow(1 + guess, t);
                    derivative += -t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                }
                if (Math.abs(npv) < precision) return guess;
                guess = guess - npv / derivative;
            }
            return NaN;
        }

        const projectIRR = calculateIRR(irrCashFlows);
        const totalCashBack = irrCashFlows.slice(1).reduce((sum, val) => sum + val, 0);
        const equityMultiple = initialCashInvested !== 0 ? totalCashBack / initialCashInvested : NaN;

        globalResults = {
            loanAmount, initialCashInvested, monthlyPmtMagnitude, annualDebtService, annualTaxes,
            gpi, egi, noi, totalOpEx, cashFlowY1, remainingDebtY5,
            projectionData, projectedSalePrice, netSaleProceeds, equityMultiple, projectIRR,
            managementFeeY1: managementFee
        };
    }

    // --- RENDERING FUNCTIONS ---

    function updateUnitAnnualRentDisplays() {
        const data = currentData;
        if (!data || !data.units) return;
        const annualCells = document.querySelectorAll('.unit-annual-rent');
        annualCells.forEach((el, index) => {
            if (data.units[index]) {
                const u = data.units[index];
                const count = typeof u.unitCount === 'number' && u.unitCount > 0 ? u.unitCount : 1;
                el.textContent = format(u.rent * 12 * count, false, false);
            }
        });
    }

    function renderUnitMixSummaryTable() {
        const tbody = document.getElementById('unitMixSummaryBody');
        if (!tbody || !currentData || !currentData.units) return;

        tbody.innerHTML = currentData.units.map(u => {
            const count = typeof u.unitCount === 'number' && u.unitCount > 0 ? u.unitCount : 1;
            const annual = u.rent * 12 * count;
            return `
                <tr>
                    <td class="p-2">${u.unitType || ''}</td>
                    <td class="p-2 text-center">${u.beds ?? ''}</td>
                    <td class="p-2 text-center">${u.baths ?? ''}</td>
                    <td class="p-2 text-right">${count}</td>
                    <td class="p-2 text-right">${format(u.rent, false, false)}</td>
                    <td class="p-2 text-right">${format(annual, false, false)}</td>
                </tr>
            `;
        }).join('');
    }

    function renderSummaryTab() {
        const { noi, annualDebtService, cashFlowY1, gpi, egi, totalOpEx, initialCashInvested } = globalResults;
        const data = currentData;
        if (!data) return;

        const coc = initialCashInvested !== 0 ? cashFlowY1 / initialCashInvested : NaN;
        const capRate = data.purchasePrice !== 0 ? noi / data.purchasePrice : NaN;
        const absADS = Math.abs(annualDebtService);
        const dscr = absADS !== 0 ? noi / absADS : NaN;

        document.getElementById('summaryPropertyAddress').textContent = data.propertyAddress || 'No Property Address Entered';
        document.getElementById('summaryMLSNumber').textContent = data.mlsNumber || 'N/A';

        document.getElementById('gpiOutput').textContent = format(gpi, false, false);
        document.getElementById('gpiInputTabOutput').textContent = format(gpi, false, false);
        document.getElementById('calcGPI').textContent = format(gpi, false, false);
        document.getElementById('vacancyRateDisplay').textContent = percentFormatter.format(data.vacancyRate);
        document.getElementById('calcVacancy').textContent = format(gpi * data.vacancyRate * -1, false, false);
        document.getElementById('calcEGI').textContent = format(egi, false, false);
        document.getElementById('calcOpEx').textContent = format(totalOpEx * -1, false, false);
        document.getElementById('calcNOI').textContent = format(noi, false, false);
        document.getElementById('calcADS').textContent = format(annualDebtService, false, false);

        const cfEl = document.getElementById('calcCashFlow');
        cfEl.textContent = format(cashFlowY1);
        cfEl.classList.toggle('negative-value', cashFlowY1 < 0);
        cfEl.classList.toggle('positive-return', cashFlowY1 > 0);

        document.getElementById('summaryPurchasePrice').textContent = format(data.purchasePrice, false, false);
        document.getElementById('summaryCashInvested').textContent = format(initialCashInvested, false, false);

        const cocEl = document.getElementById('summaryCoC');
        cocEl.textContent = format(coc, true);
        cocEl.classList.toggle('negative-value', coc < 0);
        cocEl.classList.toggle('positive-return', coc >= 0 && !isNaN(coc));

        document.getElementById('summaryCapRate').textContent = format(capRate, true);

        const dscrValue = isNaN(dscr) || !isFinite(dscr) ? 'N/A' : dscr.toFixed(2) + 'x';
        document.getElementById('summaryDSCR').textContent = dscrValue;

        const summaryCFEl = document.getElementById('summaryCashFlow');
        summaryCFEl.textContent = format(cashFlowY1);
        summaryCFEl.classList.toggle('negative-value', cashFlowY1 < 0);
        summaryCFEl.classList.toggle('positive-return', cashFlowY1 > 0);

        const dscrInterp = document.getElementById('dscrInterpretation');
        if (dscr >= 1.25) {
            dscrInterp.textContent = 'Strong (Bank Favorable)';
            dscrInterp.className = 'text-xs text-right positive-return';
        } else if (dscr >= 1.0) {
            dscrInterp.textContent = 'Acceptable (Tight)';
            dscrInterp.className = 'text-xs text-right calc-cell';
        } else {
            dscrInterp.textContent = 'Needs Improvement (High Risk)';
            dscrInterp.className = 'text-xs text-right negative-value';
        }

        renderUnitMixSummaryTable();
    }

    function renderProjectionTab() {
        const { projectionData, remainingDebtY5, projectedSalePrice, netSaleProceeds, equityMultiple, projectIRR, annualDebtService } = globalResults;
        const data = currentData;
        const tbody = document.getElementById('projectionTableBody');
        if (!tbody || !data) return;

        tbody.innerHTML = '';

        const rows = [
            { label: 'Gross Potential Income (GPI)', key: 'gpi', format: true },
            { label: 'Effective Gross Income (EGI)', key: 'egi', format: true },
            { label: 'Total Operating Expenses', key: 'opEx', format: true },
            { label: 'Net Operating Income (NOI)', key: 'noi', format: true },
            { label: 'Annual Debt Service (ADS)', key: 'ads', format: true },
            { label: 'Annual Cash Flow (CFBT)', key: 'cashFlow', format: true },
        ];

        rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'border-b';
            let html = `<td class="p-3 font-semibold ${row.key === 'cashFlow' ? 'text-blue-700' : ''}">${row.label}</td>`;

            projectionData.forEach(yearData => {
                let value = yearData[row.key];
                let cellClass = 'calc-cell';

                if (row.key === 'ads') {
                    value = annualDebtService;
                    cellClass = 'negative-value';
                } else if (row.key === 'opEx') {
                    value *= -1;
                    cellClass = 'negative-value';
                } else if (row.key === 'cashFlow') {
                    cellClass = value < 0 ? 'negative-value text-xl' : 'positive-return text-xl';
                }

                html += `<td class="p-3 text-right ${cellClass}">${format(value, false, row.format)}</td>`;
            });

            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        document.getElementById('exitCapRate').textContent = format(data.exitCapRate, true);
        document.getElementById('projectedSalePrice').textContent = format(projectedSalePrice, false, false);
        document.getElementById('remainingDebt').textContent = format(remainingDebtY5 * -1, false, false);

        const proceedsEl = document.getElementById('saleProceeds');
        proceedsEl.textContent = format(netSaleProceeds, false, false);
        proceedsEl.classList.toggle('negative-value', netSaleProceeds < 0);
        proceedsEl.classList.toggle('positive-return', netSaleProceeds >= 0);

        const equityEl = document.getElementById('equityMultiple');
        equityEl.textContent = isNaN(equityMultiple) || !isFinite(equityMultiple) ? 'N/A' : equityMultiple.toFixed(2) + 'x';
        equityEl.classList.toggle('negative-value', equityMultiple < 1);
        equityEl.classList.toggle('positive-return', equityMultiple >= 1);

        const irrEl = document.getElementById('projectIRR');
        irrEl.textContent = format(projectIRR, true);
        irrEl.classList.toggle('negative-value', projectIRR < 0);
        irrEl.classList.toggle('positive-return', projectIRR >= 0);
    }

    function renderAssumptionsTab() {
        const { loanAmount, annualDebtService, initialCashInvested, annualTaxes, monthlyPmtMagnitude, managementFeeY1 } = globalResults;

        document.getElementById('inputCashInvested').textContent = format(initialCashInvested, false, false);
        document.getElementById('inputLoanAmount').textContent = format(loanAmount, false, false);
        document.getElementById('inputMonthlyPmt').textContent = format(monthlyPmtMagnitude, false, true);
        document.getElementById('inputADS').textContent = format(Math.abs(annualDebtService), false, false);
        document.getElementById('inputTotalPayments').textContent = format(Math.abs(annualDebtService) * (currentData?.loanTermYears || 0), false, false);

        document.getElementById('outputAnnualTaxes').textContent = format(annualTaxes, false, false);
        document.getElementById('outputMgmtFee').textContent = format(managementFeeY1, false, false);
    }

    // --- MAIN CONTROL FUNCTION ---

    function renderAll() {
        if (!currentData) {
            console.error("Cannot render: currentData is null. Falling back to default initialization.");
            currentData = JSON.parse(JSON.stringify(defaultState));
            applyDataToDOMFromLoadedData(currentData);
        }
        updateUnitAnnualRentDisplays();
        renderSummaryTab();
        renderProjectionTab();
        renderAssumptionsTab();
    }

    // Core function for user interaction
    window.updateAndCalculate = function () {
        readInputs();
        runAllCalculations();
        renderAll();

        saveCurrentToLocal();

        if (isAuthReady) {
            saveDebounced();
        } else {
            console.warn("[Update/Calculate] Auth not ready. Skipping cloud save.");
        }
    };

    // --- INITIALIZATION ---
    window.initializeApp = async function () {
        setLogLevel('Debug');
        setStatus('Starting Firebase...');

        try {
            const firebaseConfig = JSON.parse(
                typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'
            );
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const initialAuthToken =
                typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            currentData = JSON.parse(JSON.stringify(defaultState));
            unitIdCounter = defaultState.units.length + 1;

            const localSnapshot = loadCurrentFromLocal();
            if (localSnapshot && localSnapshot.units && localSnapshot.units.length > 0) {
                console.log('[LocalStorage] Restoring last-used scenario.');
                currentData = localSnapshot;
            }

            applyDataToDOMFromLoadedData(currentData);
            renderUnitMixInput();
            runAllCalculations();
            renderAll();

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log(`[Firebase] User authenticated. ID: ${userId}.`);
                    setStatus('Authenticated. Loading model...');
                    loadProForma();
                } else {
                    isAuthReady = false;
                    console.error('[Firebase] Authentication failed. Using defaults.');
                    setStatus('Authentication failed. Using default data.', 'error');

                    currentData = JSON.parse(JSON.stringify(defaultState));
                    unitIdCounter = defaultState.units.length + 1;
                    applyDataToDOMFromLoadedData(currentData);
                    renderUnitMixInput();
                    updateAndCalculate();
                }
            });
        } catch (e) {
            console.error('[Firebase] Initialization Error:', e);

            setStatus('Enter fields with desired values to save a version', 'info');

            currentData = JSON.parse(JSON.stringify(defaultState));
            unitIdCounter = defaultState.units.length + 1;
            applyDataToDOMFromLoadedData(currentData);
            renderUnitMixInput();
            runAllCalculations();
            renderAll();
        }

        refreshScenarioDropdown();
        showTab('assumptions');
    };

    // --- FIXED GLOBAL TAB SWITCHER ---
    window.showTab = function (tabId) {
        document.querySelectorAll('.tab-content').forEach((tab) => {
            tab.classList.add('hidden');
        });

        document.querySelectorAll('.tab-button').forEach((button) => {
            button.classList.remove('active');
        });

        const content = document.getElementById(tabId);
        if (content) content.classList.remove('hidden');

        const btn = document.querySelector(
            `.nav-tabs button[onclick="showTab('${tabId}')"]`
        );
        if (btn) btn.classList.add('active');
    };
</script>

<!-- ===========================
     FOOTER ‚Äî Navy + Gold (Option B)
=========================== -->
<footer class="mt-16 bg-[#0A1A44] border-t-4 border-[#CFAF66] py-8 px-6 text-white">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center md:justify-between text-center md:text-left">

        <!-- Logo -->
        <div class="mb-6 md:mb-0">
            <img
                    src="SIHR-house-logo-plain.png"
                    alt="SHE IS HOPE Realty Logo"
                    class="w-24 md:w-32 mx-auto md:mx-0 drop-shadow-lg"
            />
        </div>

        <!-- Disclaimer -->
        <div class="text-gray-200 text-sm leading-relaxed md:pl-8 md:max-w-xl">
            <p>
                This pro forma tool is for estimation purposes only. All financial assumptions,
                projections, and results should be independently verified. Buyers and investors
                must perform their own due diligence regarding property condition, income, expenses,
                financing, and market risks.
            </p>

            <p class="mt-3 font-semibold text-[#CFAF66] tracking-wide">
                ¬© SHE IS HOPE Realty DRE #02098386 ‚Äî All Rights Reserved
            </p>
        </div>

    </div>
</footer>
</body>
</html>
